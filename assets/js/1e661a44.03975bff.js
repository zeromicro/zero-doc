"use strict";(self.webpackChunktmp=self.webpackChunktmp||[]).push([[7045],{3905:function(e,n,t){t.d(n,{Zo:function(){return o},kt:function(){return u}});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var p=a.createContext({}),c=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},o=function(e){var n=c(e.components);return a.createElement(p.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,p=e.parentName,o=s(e,["components","mdxType","originalType","parentName"]),m=c(t),u=r,g=m["".concat(p,".").concat(u)]||m[u]||d[u]||l;return t?a.createElement(g,i(i({ref:n},o),{},{components:t})):a.createElement(g,i({ref:n},o))}));function u(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,i=new Array(l);i[0]=m;var s={};for(var p in n)hasOwnProperty.call(n,p)&&(s[p]=n[p]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var c=2;c<l;c++)i[c]=t[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},3865:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return s},contentTitle:function(){return p},metadata:function(){return c},toc:function(){return o},default:function(){return m}});var a=t(7462),r=t(3366),l=(t(7294),t(3905)),i=["components"],s={sidebar_position:4},p="\u4e1a\u52a1\u5f00\u53d1",c={unversionedId:"project/business",id:"project/business",title:"\u4e1a\u52a1\u5f00\u53d1",description:"\u672c\u7ae0\u8282\u6211\u4eec\u7528\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\u53bb\u6f14\u793a\u4e00\u4e0bgo-zero\u4e2d\u7684\u4e00\u4e9b\u57fa\u672c\u529f\u80fd\u3002",source:"@site/docs/project/business.md",sourceDirName:"project",slug:"/project/business",permalink:"/docs/project/business",editUrl:"https://github.com/zeromicro/zero-doc/tree/main/website/docs/project/business.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"\u914d\u7f6e\u4ecb\u7ecd",permalink:"/docs/project/config"},next:{title:"CI/CD",permalink:"/docs/project/cicd"}},o=[{value:"\u6f14\u793a\u5de5\u7a0b\u4e0b\u8f7d",id:"\u6f14\u793a\u5de5\u7a0b\u4e0b\u8f7d",children:[],level:2},{value:"\u6f14\u793a\u5de5\u7a0b\u8bf4\u660e",id:"\u6f14\u793a\u5de5\u7a0b\u8bf4\u660e",children:[{value:"\u573a\u666f",id:"\u573a\u666f",children:[],level:3},{value:"\u9884\u671f\u5b9e\u73b0\u76ee\u6807",id:"\u9884\u671f\u5b9e\u73b0\u76ee\u6807",children:[],level:3},{value:"\u7cfb\u7edf\u5206\u6790",id:"\u7cfb\u7edf\u5206\u6790",children:[{value:"\u670d\u52a1\u62c6\u5206",id:"\u670d\u52a1\u62c6\u5206",children:[],level:4},{value:"\u53c2\u8003\u9884\u8bbe\u6570\u636e",id:"\u53c2\u8003\u9884\u8bbe\u6570\u636e",children:[],level:4}],level:3}],level:2},{value:"\u76ee\u5f55\u62c6\u5206",id:"\u76ee\u5f55\u62c6\u5206",children:[{value:"\u7cfb\u7edf\u7ed3\u6784\u5206\u6790",id:"\u7cfb\u7edf\u7ed3\u6784\u5206\u6790",children:[],level:3},{value:"rpc\u8c03\u7528\u94fe\u5efa\u8bae",id:"rpc\u8c03\u7528\u94fe\u5efa\u8bae",children:[],level:3},{value:"\u5e38\u89c1\u670d\u52a1\u7c7b\u578b\u7684\u76ee\u5f55\u7ed3\u6784",id:"\u5e38\u89c1\u670d\u52a1\u7c7b\u578b\u7684\u76ee\u5f55\u7ed3\u6784",children:[],level:3},{value:"\u5b8c\u6574\u5de5\u7a0b\u76ee\u5f55\u7ed3\u6784\u793a\u4f8b",id:"\u5b8c\u6574\u5de5\u7a0b\u76ee\u5f55\u7ed3\u6784\u793a\u4f8b",children:[],level:3}],level:2},{value:"model\u751f\u6210",id:"model\u751f\u6210",children:[{value:"\u51c6\u5907\u5de5\u4f5c",id:"\u51c6\u5907\u5de5\u4f5c",children:[],level:3},{value:"\u4ee3\u7801\u751f\u6210(\u5e26\u7f13\u5b58)",id:"\u4ee3\u7801\u751f\u6210\u5e26\u7f13\u5b58",children:[{value:"\u65b9\u5f0f\u4e00(ddl)",id:"\u65b9\u5f0f\u4e00ddl",children:[],level:4},{value:"\u65b9\u5f0f\u4e8c(datasource)",id:"\u65b9\u5f0f\u4e8cdatasource",children:[],level:4},{value:"\u65b9\u5f0f\u4e09(intellij \u63d2\u4ef6)",id:"\u65b9\u5f0f\u4e09intellij-\u63d2\u4ef6",children:[],level:4}],level:3},{value:"\u9a8c\u8bc1\u751f\u6210\u7684model\u6587\u4ef6",id:"\u9a8c\u8bc1\u751f\u6210\u7684model\u6587\u4ef6",children:[],level:3}],level:2},{value:"api\u6587\u4ef6\u7f16\u5199",id:"api\u6587\u4ef6\u7f16\u5199",children:[{value:"\u7f16\u5199user.api\u6587\u4ef6",id:"\u7f16\u5199userapi\u6587\u4ef6",children:[],level:3},{value:"\u751f\u6210api\u670d\u52a1",id:"\u751f\u6210api\u670d\u52a1",children:[{value:"\u65b9\u5f0f\u4e00",id:"\u65b9\u5f0f\u4e00",children:[],level:4},{value:"\u65b9\u5f0f\u4e8c",id:"\u65b9\u5f0f\u4e8c",children:[],level:4},{value:"\u65b9\u5f0f\u4e09",id:"\u65b9\u5f0f\u4e09",children:[],level:4}],level:3}],level:2},{value:"\u4e1a\u52a1\u7f16\u7801",id:"\u4e1a\u52a1\u7f16\u7801",children:[{value:"\u6dfb\u52a0Mysql\u914d\u7f6e",id:"\u6dfb\u52a0mysql\u914d\u7f6e",children:[],level:3},{value:"\u5b8c\u5584yaml\u914d\u7f6e",id:"\u5b8c\u5584yaml\u914d\u7f6e",children:[],level:3},{value:"\u5b8c\u5584\u670d\u52a1\u4f9d\u8d56",id:"\u5b8c\u5584\u670d\u52a1\u4f9d\u8d56",children:[],level:3},{value:"\u586b\u5145\u767b\u5f55\u903b\u8f91",id:"\u586b\u5145\u767b\u5f55\u903b\u8f91",children:[],level:3}],level:2},{value:"jwt\u9274\u6743",id:"jwt\u9274\u6743",children:[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",children:[],level:3},{value:"\u4ec0\u4e48\u65f6\u5019\u5e94\u8be5\u4f7f\u7528JWT",id:"\u4ec0\u4e48\u65f6\u5019\u5e94\u8be5\u4f7f\u7528jwt",children:[],level:3},{value:"\u4e3a\u4ec0\u4e48\u8981\u4f7f\u7528JSON Web\u4ee4\u724c",id:"\u4e3a\u4ec0\u4e48\u8981\u4f7f\u7528json-web\u4ee4\u724c",children:[],level:3},{value:"go-zero\u4e2d\u600e\u4e48\u4f7f\u7528jwt",id:"go-zero\u4e2d\u600e\u4e48\u4f7f\u7528jwt",children:[{value:"user api\u751f\u6210jwt token",id:"user-api\u751f\u6210jwt-token",children:[{value:"\u6dfb\u52a0\u914d\u7f6e\u5b9a\u4e49\u548cyaml\u914d\u7f6e\u9879",id:"\u6dfb\u52a0\u914d\u7f6e\u5b9a\u4e49\u548cyaml\u914d\u7f6e\u9879",children:[],level:5}],level:4},{value:"search api\u4f7f\u7528jwt token\u9274\u6743",id:"search-api\u4f7f\u7528jwt-token\u9274\u6743",children:[{value:"\u7f16\u5199search.api\u6587\u4ef6",id:"\u7f16\u5199searchapi\u6587\u4ef6",children:[],level:5},{value:"\u751f\u6210\u4ee3\u7801",id:"\u751f\u6210\u4ee3\u7801",children:[],level:5},{value:"\u6dfb\u52a0yaml\u914d\u7f6e\u9879",id:"\u6dfb\u52a0yaml\u914d\u7f6e\u9879",children:[],level:5}],level:4},{value:"\u9a8c\u8bc1 jwt token",id:"\u9a8c\u8bc1-jwt-token",children:[],level:4},{value:"\u83b7\u53d6jwt token\u4e2d\u643a\u5e26\u7684\u4fe1\u606f",id:"\u83b7\u53d6jwt-token\u4e2d\u643a\u5e26\u7684\u4fe1\u606f",children:[],level:4}],level:3}],level:2},{value:"\u4e2d\u95f4\u4ef6\u4f7f\u7528",id:"\u4e2d\u95f4\u4ef6\u4f7f\u7528",children:[{value:"\u4e2d\u95f4\u4ef6\u5206\u7c7b",id:"\u4e2d\u95f4\u4ef6\u5206\u7c7b",children:[],level:3},{value:"\u4e2d\u95f4\u4ef6\u4f7f\u7528",id:"\u4e2d\u95f4\u4ef6\u4f7f\u7528-1",children:[{value:"\u8def\u7531\u4e2d\u95f4\u4ef6",id:"\u8def\u7531\u4e2d\u95f4\u4ef6",children:[],level:4},{value:"\u5168\u5c40\u4e2d\u95f4\u4ef6",id:"\u5168\u5c40\u4e2d\u95f4\u4ef6",children:[],level:4},{value:"\u5728\u4e2d\u95f4\u4ef6\u91cc\u8c03\u7528\u5176\u5b83\u670d\u52a1",id:"\u5728\u4e2d\u95f4\u4ef6\u91cc\u8c03\u7528\u5176\u5b83\u670d\u52a1",children:[],level:4}],level:3}],level:2},{value:"rpc\u7f16\u5199\u4e0e\u8c03\u7528",id:"rpc\u7f16\u5199\u4e0e\u8c03\u7528",children:[{value:"\u573a\u666f",id:"\u573a\u666f-1",children:[],level:3},{value:"rpc\u670d\u52a1\u7f16\u5199",id:"rpc\u670d\u52a1\u7f16\u5199",children:[],level:3},{value:"\u4f7f\u7528rpc",id:"\u4f7f\u7528rpc",children:[],level:3},{value:"\u542f\u52a8\u5e76\u9a8c\u8bc1\u670d\u52a1",id:"\u542f\u52a8\u5e76\u9a8c\u8bc1\u670d\u52a1",children:[],level:3}],level:2},{value:"\u9519\u8bef\u5904\u7406",id:"\u9519\u8bef\u5904\u7406",children:[{value:"\u4e1a\u52a1\u9519\u8bef\u54cd\u5e94\u683c\u5f0f",id:"\u4e1a\u52a1\u9519\u8bef\u54cd\u5e94\u683c\u5f0f",children:[],level:3},{value:"user api\u4e4blogin",id:"user-api\u4e4blogin",children:[],level:3},{value:"\u81ea\u5b9a\u4e49\u9519\u8bef",id:"\u81ea\u5b9a\u4e49\u9519\u8bef",children:[],level:3}],level:2}],d={toc:o};function m(e){var n=e.components,t=(0,r.Z)(e,i);return(0,l.kt)("wrapper",(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"\u4e1a\u52a1\u5f00\u53d1"},"\u4e1a\u52a1\u5f00\u53d1"),(0,l.kt)("p",null,"\u672c\u7ae0\u8282\u6211\u4eec\u7528\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\u53bb\u6f14\u793a\u4e00\u4e0bgo-zero\u4e2d\u7684\u4e00\u4e9b\u57fa\u672c\u529f\u80fd\u3002"),(0,l.kt)("h2",{id:"\u6f14\u793a\u5de5\u7a0b\u4e0b\u8f7d"},"\u6f14\u793a\u5de5\u7a0b\u4e0b\u8f7d"),(0,l.kt)("p",null,"\u5728\u6b63\u5f0f\u8fdb\u5165\u540e\u7eed\u6587\u6863\u53d9\u8ff0\u524d\uff0c\u53ef\u4ee5\u5148\u7559\u610f\u4e00\u4e0b\u8fd9\u91cc\u7684\u6e90\u7801\uff0c\u540e\u7eed\u6211\u4eec\u4f1a\u57fa\u4e8e\u8fd9\u4efd\u6e90\u7801\u8fdb\u884c\u529f\u80fd\u7684\u9012\u8fdb\u5f0f\u6f14\u793a\uff0c\n\u800c\u4e0d\u662f\u5b8c\u5168\u4ece0\u5f00\u59cb\uff0c\u5982\u679c\u4f60\u4ece",(0,l.kt)("a",{parentName:"p",href:"/docs/quick-start/concept"},"\u5feb\u901f\u5165\u95e8"),"\u7ae0\u8282\u8fc7\u6765\uff0c\u8fd9\u4efd\u6e90\u7801\u7ed3\u6784\u5bf9\u4f60\u6765\u8bf4\u4e0d\u662f\u95ee\u9898\u3002"),(0,l.kt)("p",null,"\u70b9\u51fb",(0,l.kt)("a",{href:"https://zeromicro.github.io/go-zero-pages/resource/book.zip"},"\u8fd9\u91cc\u4e0b\u8f7d"),"\u6f14\u793a\u5de5\u7a0b\u57fa\u7840\u6e90\u7801"),(0,l.kt)("h2",{id:"\u6f14\u793a\u5de5\u7a0b\u8bf4\u660e"},"\u6f14\u793a\u5de5\u7a0b\u8bf4\u660e"),(0,l.kt)("h3",{id:"\u573a\u666f"},"\u573a\u666f"),(0,l.kt)("p",null,"\u7a0b\u5e8f\u5458\u5c0f\u660e\u9700\u8981\u501f\u9605\u4e00\u672c\u300a\u897f\u6e38\u8bb0\u300b\uff0c\u5728\u6ca1\u6709\u7ebf\u4e0a\u56fe\u4e66\u7ba1\u7406\u7cfb\u7edf\u7684\u65f6\u5019\uff0c\u4ed6\u6bcf\u5929\u90fd\u8981\u53bb\u56fe\u4e66\u9986\u524d\u53f0\u54a8\u8be2\u56fe\u4e66\u9986\u7ba1\u7406\u5458\uff0c"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5c0f\u660e\uff1a\u4f60\u597d\uff0c\u8bf7\u95ee\u4eca\u5929\u300a\u897f\u6e38\u8bb0\u300b\u7684\u56fe\u4e66\u8fd8\u6709\u5417\uff1f"),(0,l.kt)("li",{parentName:"ul"},"\u7ba1\u7406\u5458\uff1a\u6ca1\u6709\u4e86\uff0c\u660e\u5929\u518d\u6765\u770b\u770b\u5427\u3002")),(0,l.kt)("p",null,"\u8fc7\u4e86\u4e00\u5929\uff0c\u5c0f\u660e\u53c8\u6765\u5230\u56fe\u4e66\u9986\uff0c\u95ee\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5c0f\u660e\uff1a\u4f60\u597d\uff0c\u8bf7\u95ee\u4eca\u5929\u300a\u897f\u6e38\u8bb0\u300b\u7684\u56fe\u4e66\u8fd8\u6709\u5417\uff1f"),(0,l.kt)("li",{parentName:"ul"},"\u7ba1\u7406\u5458\uff1a\u6ca1\u6709\u4e86\uff0c\u4f60\u8fc7\u4e24\u5929\u518d\u6765\u770b\u770b\u5427\u3002")),(0,l.kt)("p",null,"\u5c31\u8fd9\u6837\u7ecf\u8fc7\u591a\u6b21\u53cd\u590d\uff0c\u5c0f\u660e\u4e5f\u662f\u5f92\u52b3\u65e0\u529f\uff0c\u6d6a\u8d39\u5927\u91cf\u65f6\u95f4\u5728\u6765\u56de\u7684\u8def\u4e0a\uff0c\u4e8e\u662f\u7ec8\u4e8e\u5fcd\u53d7\u4e0d\u4e86\u843d\u540e\u7684\u56fe\u4e66\u7ba1\u7406\u7cfb\u7edf\uff0c\n\u4ed6\u51b3\u5b9a\u81ea\u5df1\u4eb2\u624b\u505a\u4e00\u4e2a\u56fe\u4e66\u67e5\u9605\u7cfb\u7edf\u3002"),(0,l.kt)("h3",{id:"\u9884\u671f\u5b9e\u73b0\u76ee\u6807"},"\u9884\u671f\u5b9e\u73b0\u76ee\u6807"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u7528\u6237\u767b\u5f55\n\u4f9d\u9760\u73b0\u6709\u5b66\u751f\u7cfb\u7edf\u6570\u636e\u8fdb\u884c\u767b\u5f55"),(0,l.kt)("li",{parentName:"ul"},"\u56fe\u4e66\u68c0\u7d22\n\u6839\u636e\u56fe\u4e66\u5173\u952e\u5b57\u641c\u7d22\u56fe\u4e66\uff0c\u67e5\u8be2\u56fe\u4e66\u5269\u4f59\u6570\u91cf\u3002")),(0,l.kt)("h3",{id:"\u7cfb\u7edf\u5206\u6790"},"\u7cfb\u7edf\u5206\u6790"),(0,l.kt)("h4",{id:"\u670d\u52a1\u62c6\u5206"},"\u670d\u52a1\u62c6\u5206"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"user",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"api \u63d0\u4f9b\u7528\u6237\u767b\u5f55\u534f\u8bae"),(0,l.kt)("li",{parentName:"ul"},"rpc \u4f9bsearch\u670d\u52a1\u8bbf\u95ee\u7528\u6237\u6570\u636e"))),(0,l.kt)("li",{parentName:"ul"},"search",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"api \u63d0\u4f9b\u56fe\u4e66\u67e5\u8be2\u534f\u8bae")))),(0,l.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"\u8fd9\u4e2a\u5fae\u5c0f\u7684\u56fe\u4e66\u501f\u9605\u67e5\u8be2\u7cfb\u7edf\u867d\u7136\u5c0f\uff0c\u4ece\u5b9e\u9645\u6765\u8bb2\u4e0d\u592a\u7b26\u5408\u4e1a\u52a1\u573a\u666f\uff0c\u4f46\u662f\u4ec5\u4e0a\u9762\u4e24\u4e2a\u529f\u80fd\uff0c\u5df2\u7ecf\u6ee1\u8db3\u6211\u4eec\u5bf9go-zero api/rpc\u7684\u573a\u666f\u6f14\u793a\u4e86\uff0c\n\u540e\u7eed\u4e3a\u4e86\u6ee1\u8db3\u66f4\u4e30\u5bcc\u7684go-zero\u529f\u80fd\u6f14\u793a\uff0c\u4f1a\u5728\u6587\u6863\u4e2d\u8fdb\u884c\u4e1a\u52a1\u63d2\u5165\u5373\u76f8\u5173\u529f\u80fd\u63cf\u8ff0\u3002\u8fd9\u91cc\u4ec5\u7528\u4e00\u4e2a\u573a\u666f\u8fdb\u884c\u5f15\u5165\u3002"),(0,l.kt)("p",{parentName:"div"},"\u6ce8\u610f\uff1auser\u4e2d\u7684sql\u8bed\u53e5\u8bf7\u81ea\u884c\u521b\u5efa\u5230db\u4e2d\u53bb\uff0c\u66f4\u591a\u51c6\u5907\u5de5\u4f5c\u89c1",(0,l.kt)("strong",{parentName:"p"},(0,l.kt)("a",{parentName:"strong",href:"/docs/project/prepare"},"\u51c6\u5907\u5de5\u4f5c"))),(0,l.kt)("p",{parentName:"div"},"\u6dfb\u52a0\u4e00\u4e9b\u9884\u8bbe\u7684\u7528\u6237\u6570\u636e\u5230\u6570\u636e\u5e93\uff0c\u4fbf\u4e8e\u540e\u9762\u4f7f\u7528\uff0c\u4e3a\u4e86\u7bc7\u5e45\uff0c\u6f14\u793a\u5de5\u7a0b\u4e0d\u5bf9\u63d2\u5165\u6570\u636e\u8fd9\u79cd\u64cd\u4f5c\u505a\u8be6\u7ec6\u6f14\u793a\u3002"))),(0,l.kt)("h4",{id:"\u53c2\u8003\u9884\u8bbe\u6570\u636e"},"\u53c2\u8003\u9884\u8bbe\u6570\u636e"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO `user` (number,name,password,gender)values ('666','\u5c0f\u660e','123456','\u7537');\n")),(0,l.kt)("h2",{id:"\u76ee\u5f55\u62c6\u5206"},"\u76ee\u5f55\u62c6\u5206"),(0,l.kt)("p",null,"\u76ee\u5f55\u62c6\u5206\u662f\u6307\u914d\u5408go-zero\u7684\u6700\u4f73\u5b9e\u8df5\u7684\u76ee\u5f55\u62c6\u5206\uff0c\u8fd9\u548c\u5fae\u670d\u52a1\u62c6\u5206\u6709\u7740\u5173\u8054\uff0c\u5728\u56e2\u961f\u5185\u90e8\u6700\u4f73\u5b9e\u8df5\u4e2d\uff0c\n\u6211\u4eec\u6309\u7167\u4e1a\u52a1\u6a2a\u5411\u62c6\u5206\uff0c\u5c06\u4e00\u4e2a\u7cfb\u7edf\u62c6\u5206\u6210\u591a\u4e2a\u5b50\u7cfb\u7edf\uff0c\u6bcf\u4e2a\u5b50\u7cfb\u7edf\u5e94\u62e5\u6709\u72ec\u7acb\u7684\u6301\u4e45\u5316\u5b58\u50a8\uff0c\u7f13\u5b58\u7cfb\u7edf\u3002\n\u5982\u4e00\u4e2a\u5546\u57ce\u7cfb\u7edf\u9700\u8981\u6709\u7528\u6237\u7cfb\u7edf(user)\uff0c\u5546\u54c1\u7ba1\u7406\u7cfb\u7edf(product)\uff0c\u8ba2\u5355\u7cfb\u7edf(order)\uff0c\u8d2d\u7269\u8f66\u7cfb\u7edf(cart)\uff0c\u7ed3\u7b97\u4e2d\u5fc3\u7cfb\u7edf(pay)\uff0c\u552e\u540e\u7cfb\u7edf(afterSale)\u7b49\u7ec4\u6210\u3002"),(0,l.kt)("h3",{id:"\u7cfb\u7edf\u7ed3\u6784\u5206\u6790"},"\u7cfb\u7edf\u7ed3\u6784\u5206\u6790"),(0,l.kt)("p",null,"\u5728\u4e0a\u6587\u63d0\u5230\u7684\u5546\u57ce\u7cfb\u7edf\u4e2d\uff0c\u6bcf\u4e2a\u7cfb\u7edf\u5728\u5bf9\u5916\uff08http\uff09\u63d0\u4f9b\u670d\u52a1\u7684\u540c\u65f6\uff0c\u4e5f\u4f1a\u63d0\u4f9b\u6570\u636e\u7ed9\u5176\u4ed6\u5b50\u7cfb\u7edf\u8fdb\u884c\u6570\u636e\u8bbf\u95ee\u7684\u63a5\u53e3\uff08rpc\uff09\uff0c\u56e0\u6b64\u6bcf\u4e2a\u5b50\u7cfb\u7edf\u53ef\u4ee5\u62c6\u5206\u6210\u4e00\u4e2a\u670d\u52a1\uff0c\u800c\u4e14\u5bf9\u5916\u63d0\u4f9b\u4e86\u4e24\u79cd\u8bbf\u95ee\u8be5\u7cfb\u7edf\u7684\u65b9\u5f0fapi\u548crpc\uff0c\u56e0\u6b64\uff0c\n\u4ee5\u4e0a\u7cfb\u7edf\u6309\u7167\u76ee\u5f55\u7ed3\u6784\u6765\u62c6\u5206\u6709\u5982\u4e0b\u7ed3\u6784:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-text"},".\n\u251c\u2500\u2500 afterSale\n\u2502\xa0\xa0 \u251c\u2500\u2500 api\n\u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n\u251c\u2500\u2500 cart\n\u2502\xa0\xa0 \u251c\u2500\u2500 api\n\u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n\u251c\u2500\u2500 order\n\u2502\xa0\xa0 \u251c\u2500\u2500 api\n\u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n\u251c\u2500\u2500 pay\n\u2502\xa0\xa0 \u251c\u2500\u2500 api\n\u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n\u251c\u2500\u2500 product\n\u2502\xa0\xa0 \u251c\u2500\u2500 api\n\u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n\u2514\u2500\u2500 user\n    \u251c\u2500\u2500 api\n    \u2514\u2500\u2500 rpc\n")),(0,l.kt)("h3",{id:"rpc\u8c03\u7528\u94fe\u5efa\u8bae"},"rpc\u8c03\u7528\u94fe\u5efa\u8bae"),(0,l.kt)("p",null,"\u5728\u8bbe\u8ba1\u7cfb\u7edf\u65f6\uff0c\u5c3d\u91cf\u505a\u5230\u670d\u52a1\u4e4b\u95f4\u8c03\u7528\u94fe\u662f\u5355\u5411\u7684\uff0c\u800c\u975e\u5faa\u73af\u8c03\u7528\uff0c\u4f8b\u5982\uff1aorder\u670d\u52a1\u8c03\u7528\u4e86user\u670d\u52a1\uff0c\u800cuser\u670d\u52a1\u53cd\u8fc7\u6765\u4e5f\u4f1a\u8c03\u7528order\u7684\u670d\u52a1\uff0c\n\u5f53\u5176\u4e2d\u4e00\u4e2a\u670d\u52a1\u542f\u52a8\u6545\u969c\uff0c\u5c31\u4f1a\u76f8\u4e92\u5f71\u54cd\uff0c\u8fdb\u5165\u6b7b\u5faa\u73af\uff0c\u4f60order\u8ba4\u4e3a\u662fuser\u670d\u52a1\u6545\u969c\u5bfc\u81f4\u7684\uff0c\u800cuser\u8ba4\u4e3a\u662forder\u670d\u52a1\u5bfc\u81f4\u7684\uff0c\u5982\u679c\u6709\u5927\u91cf\u670d\u52a1\u5b58\u5728\u76f8\u4e92\u8c03\u7528\u94fe\uff0c\n\u5219\u9700\u8981\u8003\u8651\u670d\u52a1\u62c6\u5206\u662f\u5426\u5408\u7406\u3002"),(0,l.kt)("h3",{id:"\u5e38\u89c1\u670d\u52a1\u7c7b\u578b\u7684\u76ee\u5f55\u7ed3\u6784"},"\u5e38\u89c1\u670d\u52a1\u7c7b\u578b\u7684\u76ee\u5f55\u7ed3\u6784"),(0,l.kt)("p",null,"\u5728\u4e0a\u8ff0\u670d\u52a1\u4e2d\uff0c\u4ec5\u5217\u4e3e\u4e86api/rpc\u670d\u52a1\uff0c\u9664\u6b64\u4e4b\u5916\uff0c\u4e00\u4e2a\u670d\u52a1\u4e0b\u8fd8\u53ef\u80fd\u6709\u5176\u4ed6\u66f4\u591a\u670d\u52a1\u7c7b\u578b\uff0c\u5982rmq\uff08\u6d88\u606f\u5904\u7406\u7cfb\u7edf\uff09\uff0ccron\uff08\u5b9a\u65f6\u4efb\u52a1\u7cfb\u7edf\uff09\uff0cscript\uff08\u811a\u672c\uff09\u7b49\uff0c\n\u56e0\u6b64\u4e00\u4e2a\u670d\u52a1\u4e0b\u53ef\u80fd\u5305\u542b\u4ee5\u4e0b\u76ee\u5f55\u7ed3\u6784\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-text"},"user\n    \u251c\u2500\u2500 api //  http\u8bbf\u95ee\u670d\u52a1\uff0c\u4e1a\u52a1\u9700\u6c42\u5b9e\u73b0\n    \u251c\u2500\u2500 cronjob // \u5b9a\u65f6\u4efb\u52a1\uff0c\u5b9a\u65f6\u6570\u636e\u66f4\u65b0\u4e1a\u52a1\n    \u251c\u2500\u2500 rmq // \u6d88\u606f\u5904\u7406\u7cfb\u7edf\uff1amq\u548cdq\uff0c\u5904\u7406\u4e00\u4e9b\u9ad8\u5e76\u53d1\u548c\u5ef6\u65f6\u6d88\u606f\u4e1a\u52a1\n    \u251c\u2500\u2500 rpc // rpc\u670d\u52a1\uff0c\u7ed9\u5176\u4ed6\u5b50\u7cfb\u7edf\u63d0\u4f9b\u57fa\u7840\u6570\u636e\u8bbf\u95ee\n    \u2514\u2500\u2500 script // \u811a\u672c\uff0c\u5904\u7406\u4e00\u4e9b\u4e34\u65f6\u8fd0\u8425\u9700\u6c42\uff0c\u4e34\u65f6\u6570\u636e\u4fee\u590d\n")),(0,l.kt)("h3",{id:"\u5b8c\u6574\u5de5\u7a0b\u76ee\u5f55\u7ed3\u6784\u793a\u4f8b"},"\u5b8c\u6574\u5de5\u7a0b\u76ee\u5f55\u7ed3\u6784\u793a\u4f8b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-text"},"mall // \u5de5\u7a0b\u540d\u79f0\n\u251c\u2500\u2500 common // \u901a\u7528\u5e93\n\u2502\xa0\xa0 \u251c\u2500\u2500 randx\n\u2502\xa0\xa0 \u2514\u2500\u2500 stringx\n\u251c\u2500\u2500 go.mod\n\u251c\u2500\u2500 go.sum\n\u2514\u2500\u2500 service // \u670d\u52a1\u5b58\u653e\u76ee\u5f55\n    \u251c\u2500\u2500 afterSale\n    \u2502\xa0\xa0 \u251c\u2500\u2500 api\n    \u2502\xa0\xa0 \u2514\u2500\u2500 model\n    \u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n    \u251c\u2500\u2500 cart\n    \u2502\xa0\xa0 \u251c\u2500\u2500 api\n    \u2502\xa0\xa0 \u2514\u2500\u2500 model\n    \u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n    \u251c\u2500\u2500 order\n    \u2502\xa0\xa0 \u251c\u2500\u2500 api\n    \u2502\xa0\xa0 \u2514\u2500\u2500 model\n    \u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n    \u251c\u2500\u2500 pay\n    \u2502\xa0\xa0 \u251c\u2500\u2500 api\n    \u2502\xa0\xa0 \u2514\u2500\u2500 model\n    \u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n    \u251c\u2500\u2500 product\n    \u2502\xa0\xa0 \u251c\u2500\u2500 api\n    \u2502\xa0\xa0 \u2514\u2500\u2500 model\n    \u2502\xa0\xa0 \u2514\u2500\u2500 rpc\n    \u2514\u2500\u2500 user\n        \u251c\u2500\u2500 api\n        \u251c\u2500\u2500 cronjob\n        \u251c\u2500\u2500 model\n        \u251c\u2500\u2500 rmq\n        \u251c\u2500\u2500 rpc\n        \u2514\u2500\u2500 script\n")),(0,l.kt)("h2",{id:"model\u751f\u6210"},"model\u751f\u6210"),(0,l.kt)("p",null,"\u9996\u5148\uff0c\u4e0b\u8f7d\u597d",(0,l.kt)("a",{parentName:"p",href:"https://go-zero.dev/cn/resource/book.zip"},"\u6f14\u793a\u5de5\u7a0b")," \u540e\uff0c\u6211\u4eec\u4ee5user\u7684model\u6765\u8fdb\u884c\u4ee3\u7801\u751f\u6210\u6f14\u793a\u3002"),(0,l.kt)("p",null,"model\u662f\u670d\u52a1\u8bbf\u95ee\u6301\u4e45\u5316\u6570\u636e\u5c42\u7684\u6865\u6881\uff0c\u4e1a\u52a1\u7684\u6301\u4e45\u5316\u6570\u636e\u5e38\u5b58\u5728\u4e8emysql\uff0cmongo\u7b49\u6570\u636e\u5e93\u4e2d\uff0c\u6211\u4eec\u90fd\u77e5\u9053\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u6570\u636e\u5e93\u7684\u64cd\u4f5c\u83ab\u8fc7\u4e8eCURD\uff0c\n\u800c\u8fd9\u4e9b\u5de5\u4f5c\u4e5f\u4f1a\u5360\u7528\u4e00\u90e8\u5206\u65f6\u95f4\u6765\u8fdb\u884c\u5f00\u53d1\uff0c\u6211\u66fe\u7ecf\u5728\u7f16\u5199\u4e00\u4e2a\u4e1a\u52a1\u65f6\u5199\u4e8640\u4e2amodel\u6587\u4ef6\uff0c\u6839\u636e\u4e0d\u540c\u4e1a\u52a1\u9700\u6c42\u7684\u590d\u6742\u6027\uff0c\u5e73\u5747\u6bcf\u4e2amodel\u6587\u4ef6\u5dee\u4e0d\u591a\u9700\u8981\n10\u5206\u949f\uff0c\u5bf9\u4e8e40\u4e2a\u6587\u4ef6\u6765\u8bf4\uff0c400\u5206\u949f\u7684\u5de5\u4f5c\u65f6\u95f4\uff0c\u5dee\u4e0d\u591a\u4e00\u5929\u7684\u5de5\u4f5c\u91cf\uff0c\u800cgoctl\u5de5\u5177\u53ef\u4ee5\u572810\u79d2\u949f\u6765\u5b8c\u6210\u8fd9400\u5206\u949f\u7684\u5de5\u4f5c\u3002"),(0,l.kt)("h3",{id:"\u51c6\u5907\u5de5\u4f5c"},"\u51c6\u5907\u5de5\u4f5c"),(0,l.kt)("p",null,"\u8fdb\u5165\u6f14\u793a\u5de5\u7a0bbook\uff0c\u627e\u5230user/model\u4e0b\u7684user.sql\u6587\u4ef6\uff0c\u5c06\u5176\u5728\u4f60\u81ea\u5df1\u7684\u6570\u636e\u5e93\u4e2d\u6267\u884c\u5efa\u8868\u3002"),(0,l.kt)("h3",{id:"\u4ee3\u7801\u751f\u6210\u5e26\u7f13\u5b58"},"\u4ee3\u7801\u751f\u6210(\u5e26\u7f13\u5b58)"),(0,l.kt)("h4",{id:"\u65b9\u5f0f\u4e00ddl"},"\u65b9\u5f0f\u4e00(ddl)"),(0,l.kt)("p",null,"\u8fdb\u5165",(0,l.kt)("inlineCode",{parentName:"p"},"service/user/model"),"\u76ee\u5f55\uff0c\u6267\u884c\u547d\u4ee4"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd service/user/model\n$ goctl model mysql ddl -src user.sql -dir . -c\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-text"},"Done.\n")),(0,l.kt)("h4",{id:"\u65b9\u5f0f\u4e8cdatasource"},"\u65b9\u5f0f\u4e8c(datasource)"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ goctl model mysql datasource -url="$datasource" -table="user" -c -dir .\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-text"},"Done.\n")),(0,l.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"$datasource\u4e3a\u6570\u636e\u5e93\u8fde\u63a5\u5730\u5740"))),(0,l.kt)("h4",{id:"\u65b9\u5f0f\u4e09intellij-\u63d2\u4ef6"},"\u65b9\u5f0f\u4e09(intellij \u63d2\u4ef6)"),(0,l.kt)("p",null,"\u5728Goland\u4e2d\uff0c\u53f3\u952e",(0,l.kt)("inlineCode",{parentName:"p"},"user.sql"),"\uff0c\u4f9d\u6b21\u8fdb\u5165\u5e76\u70b9\u51fb",(0,l.kt)("inlineCode",{parentName:"p"},"New"),"->",(0,l.kt)("inlineCode",{parentName:"p"},"Go Zero"),"->",(0,l.kt)("inlineCode",{parentName:"p"},"Model Code"),"\u5373\u53ef\u751f\u6210\uff0c\u6216\u8005\u6253\u5f00",(0,l.kt)("inlineCode",{parentName:"p"},"user.sql"),"\u6587\u4ef6\uff0c\n\u8fdb\u5165\u7f16\u8f91\u533a\uff0c\u4f7f\u7528\u5feb\u6377\u952e",(0,l.kt)("inlineCode",{parentName:"p"},"Command+N"),"\uff08for mac OS\uff09\u6216\u8005 ",(0,l.kt)("inlineCode",{parentName:"p"},"alt+insert"),"\uff08for windows\uff09\uff0c\u9009\u62e9",(0,l.kt)("inlineCode",{parentName:"p"},"Mode Code"),"\u5373\u53ef"),(0,l.kt)("p",null,(0,l.kt)("img",{parentName:"p",src:"https://zeromicro.github.io/go-zero-pages/resource/intellij-model.png",alt:"model\u751f\u6210"})),(0,l.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"intellij\u63d2\u4ef6\u751f\u6210\u9700\u8981\u5b89\u88c5goctl\u63d2\u4ef6"))),(0,l.kt)("h3",{id:"\u9a8c\u8bc1\u751f\u6210\u7684model\u6587\u4ef6"},"\u9a8c\u8bc1\u751f\u6210\u7684model\u6587\u4ef6"),(0,l.kt)("p",null,"\u67e5\u770btree"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ tree\uff0c\u4f9d\u6b21\u70b9\u51fb\u8fdb\u5165 New->Go Zero->Api Code\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-text"},".\n\u251c\u2500\u2500 user.sql\n\u251c\u2500\u2500 usermodel.go\n\u2514\u2500\u2500 vars.go\n")),(0,l.kt)("h2",{id:"api\u6587\u4ef6\u7f16\u5199"},"api\u6587\u4ef6\u7f16\u5199"),(0,l.kt)("h3",{id:"\u7f16\u5199userapi\u6587\u4ef6"},"\u7f16\u5199user.api\u6587\u4ef6"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/cmd/api/user.api  \n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-text"},'type (\n    LoginReq {\n        Username string `json:"username"`\n        Password string `json:"password"`\n    }\n\n    LoginReply {\n        Id           int64 `json:"id"`\n        Name         string `json:"name"`\n        Gender       string `json:"gender"`\n        AccessToken  string `json:"accessToken"`\n        AccessExpire int64 `json:"accessExpire"`\n        RefreshAfter int64 `json:"refreshAfter"`\n    }\n)\n\nservice user-api {\n    @handler login\n    post /user/login (LoginReq) returns (LoginReply)\n}\n')),(0,l.kt)("h3",{id:"\u751f\u6210api\u670d\u52a1"},"\u751f\u6210api\u670d\u52a1"),(0,l.kt)("h4",{id:"\u65b9\u5f0f\u4e00"},"\u65b9\u5f0f\u4e00"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd book/service/user/cmd/api\n$ goctl api go -api user.api -dir . \n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-text"},"Done.\n")),(0,l.kt)("h4",{id:"\u65b9\u5f0f\u4e8c"},"\u65b9\u5f0f\u4e8c"),(0,l.kt)("p",null,"\u5728 ",(0,l.kt)("inlineCode",{parentName:"p"},"user.api")," \u6587\u4ef6\u53f3\u952e\uff0c\u4f9d\u6b21\u70b9\u51fb\u8fdb\u5165 ",(0,l.kt)("inlineCode",{parentName:"p"},"New"),"->",(0,l.kt)("inlineCode",{parentName:"p"},"Go Zero"),"->",(0,l.kt)("inlineCode",{parentName:"p"},"Api Code")," \uff0c\u8fdb\u5165\u76ee\u6807\u76ee\u5f55\u9009\u62e9\uff0c\u5373api\u6e90\u7801\u7684\u76ee\u6807\u5b58\u653e\u76ee\u5f55\uff0c\u9ed8\u8ba4\u4e3auser.api\u6240\u5728\u76ee\u5f55\uff0c\u9009\u62e9\u597d\u76ee\u5f55\u540e\u70b9\u51fbOK\u5373\u53ef\u3002\n",(0,l.kt)("img",{parentName:"p",src:"https://zeromicro.github.io/go-zero-pages/resource/goctl-api.png",alt:"api\u751f\u6210"}),"\n",(0,l.kt)("img",{parentName:"p",src:"https://zeromicro.github.io/go-zero-pages/resource/goctl-api-select.png",alt:"api\u751f\u6210\u76ee\u5f55\u9009\u62e9"})),(0,l.kt)("h4",{id:"\u65b9\u5f0f\u4e09"},"\u65b9\u5f0f\u4e09"),(0,l.kt)("p",null,"\u6253\u5f00user.api\uff0c\u8fdb\u5165\u7f16\u8f91\u533a,\u4f7f\u7528\u5feb\u6377\u952e",(0,l.kt)("inlineCode",{parentName:"p"},"Command+N"),"\uff08for mac OS\uff09\u6216\u8005 ",(0,l.kt)("inlineCode",{parentName:"p"},"alt+insert"),"\uff08for windows\uff09\uff0c\u9009\u62e9",(0,l.kt)("inlineCode",{parentName:"p"},"Api Code"),"\uff0c\u540c\u6837\u8fdb\u5165\u76ee\u5f55\u9009\u62e9\u5f39\u7a97\uff0c\u9009\u62e9\u597d\u76ee\u5f55\u540e\u70b9\u51fbOK\u5373\u53ef\u3002"),(0,l.kt)("h2",{id:"\u4e1a\u52a1\u7f16\u7801"},"\u4e1a\u52a1\u7f16\u7801"),(0,l.kt)("p",null,"\u524d\u9762\u4e00\u8282\uff0c\u6211\u4eec\u5df2\u7ecf\u6839\u636e\u521d\u6b65\u9700\u6c42\u7f16\u5199\u4e86user.api\u6765\u63cf\u8ff0user\u670d\u52a1\u5bf9\u5916\u63d0\u4f9b\u54ea\u4e9b\u670d\u52a1\u8bbf\u95ee\uff0c\u5728\u672c\u8282\u6211\u4eec\u63a5\u7740\u524d\u9762\u7684\u6b65\u4f10\uff0c\n\u901a\u8fc7\u4e1a\u52a1\u7f16\u7801\u6765\u8bb2\u8ff0go-zero\u600e\u4e48\u5728\u5b9e\u9645\u4e1a\u52a1\u4e2d\u4f7f\u7528\u3002"),(0,l.kt)("h3",{id:"\u6dfb\u52a0mysql\u914d\u7f6e"},"\u6dfb\u52a0Mysql\u914d\u7f6e"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/cmd/api/internal/config/config.go\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'package config\n\nimport "github.com/tal-tech/go-zero/rest"\n\ntype Config struct {\n    rest.RestConf\n    Mysql struct{\n        DataSource string\n    }\n    \n    CacheRedis cache.CacheConf\n}\n')),(0,l.kt)("h3",{id:"\u5b8c\u5584yaml\u914d\u7f6e"},"\u5b8c\u5584yaml\u914d\u7f6e"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/cmd/api/etc/user-api.yaml\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"Name: user-api\nHost: 0.0.0.0\nPort: 8888\nMysql:\n  DataSource: $user:$password@tcp($url)/$db?charset=utf8mb4&parseTime=true&loc=Asia%2FShanghai\nCacheRedis:\n  - Host: $host\n    Pass: $pass\n    Type: node\n")),(0,l.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"$user: mysql\u6570\u636e\u5e93user"),(0,l.kt)("p",{parentName:"div"},"$password: mysql\u6570\u636e\u5e93\u5bc6\u7801"),(0,l.kt)("p",{parentName:"div"},"$url: mysql\u6570\u636e\u5e93\u8fde\u63a5\u5730\u5740"),(0,l.kt)("p",{parentName:"div"},"$db: mysql\u6570\u636e\u5e93db\u540d\u79f0\uff0c\u5373user\u8868\u6240\u5728database"),(0,l.kt)("p",{parentName:"div"},"$host: redis\u8fde\u63a5\u5730\u5740 \u683c\u5f0f\uff1aip:port\uff0c\u5982:127.0.0.1:6379"),(0,l.kt)("p",{parentName:"div"},"$pass: redis\u5bc6\u7801"))),(0,l.kt)("h3",{id:"\u5b8c\u5584\u670d\u52a1\u4f9d\u8d56"},"\u5b8c\u5584\u670d\u52a1\u4f9d\u8d56"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/cmd/api/internal/svc/servicecontext.go\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},"type ServiceContext struct {\n    Config    config.Config\n    UserModel model.UserModel\n}\n\nfunc NewServiceContext(c config.Config) *ServiceContext {\n    conn:=sqlx.NewMysql(c.Mysql.DataSource)\n    return &ServiceContext{\n        Config: c,\n        UserModel: model.NewUserModel(conn,c.CacheRedis),\n    }\n}\n")),(0,l.kt)("h3",{id:"\u586b\u5145\u767b\u5f55\u903b\u8f91"},"\u586b\u5145\u767b\u5f55\u903b\u8f91"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/cmd/api/internal/logic/loginlogic.go\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func (l *LoginLogic) Login(req types.LoginReq) (*types.LoginReply, error) {\n    if len(strings.TrimSpace(req.Username)) == 0 || len(strings.TrimSpace(req.Password)) == 0 {\n        return nil, errors.New("\u53c2\u6570\u9519\u8bef")\n    }\n    \n    userInfo, err := l.svcCtx.UserModel.FindOneByNumber(req.Username)\n    switch err {\n    case nil:\n    case model.ErrNotFound:\n        return nil, errors.New("\u7528\u6237\u540d\u4e0d\u5b58\u5728")\n    default:\n        return nil, err\n    }\n    \n    if userInfo.Password != req.Password {\n        return nil, errors.New("\u7528\u6237\u5bc6\u7801\u4e0d\u6b63\u786e")\n    }\n    \n    // ---start---\n    now := time.Now().Unix()\n    accessExpire := l.svcCtx.Config.Auth.AccessExpire\n    jwtToken, err := l.getJwtToken(l.svcCtx.Config.Auth.AccessSecret, now, l.svcCtx.Config.Auth.AccessExpire, userInfo.Id)\n    if err != nil {\n        return nil, err\n    }\n    // ---end---\n    \n    return &types.LoginReply{\n        Id:           userInfo.Id,\n        Name:         userInfo.Name,\n        Gender:       userInfo.Gender,\n        AccessToken:  jwtToken,\n        AccessExpire: now + accessExpire,\n        RefreshAfter: now + accessExpire/2,\n    }, nil\n}  \n')),(0,l.kt)("h2",{id:"jwt\u9274\u6743"},"jwt\u9274\u6743"),(0,l.kt)("h3",{id:"\u6982\u8ff0"},"\u6982\u8ff0"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"JSON Web\u4ee4\u724c\uff08JWT\uff09\u662f\u4e00\u4e2a\u5f00\u653e\u6807\u51c6\uff08RFC 7519\uff09\uff0c\u5b83\u5b9a\u4e49\u4e86\u4e00\u79cd\u7d27\u51d1\u800c\u72ec\u7acb\u7684\u65b9\u6cd5\uff0c\u7528\u4e8e\u5728\u5404\u65b9\u4e4b\u95f4\u5b89\u5168\u5730\u5c06\u4fe1\u606f\u4f5c\u4e3aJSON\u5bf9\u8c61\u4f20\u8f93\u3002\u7531\u4e8e\u6b64\u4fe1\u606f\u662f\u7ecf\u8fc7\u6570\u5b57\u7b7e\u540d\u7684\uff0c\u56e0\u6b64\u53ef\u4ee5\u88ab\u9a8c\u8bc1\u548c\u4fe1\u4efb\u3002\u53ef\u4ee5\u4f7f\u7528\u79d8\u5bc6\uff08\u4f7f\u7528HMAC\u7b97\u6cd5\uff09\u6216\u4f7f\u7528RSA\u6216ECDSA\u7684\u516c\u94a5/\u79c1\u94a5\u5bf9\u5bf9JWT\u8fdb\u884c\u7b7e\u540d\u3002")),(0,l.kt)("h3",{id:"\u4ec0\u4e48\u65f6\u5019\u5e94\u8be5\u4f7f\u7528jwt"},"\u4ec0\u4e48\u65f6\u5019\u5e94\u8be5\u4f7f\u7528JWT"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u6388\u6743\uff1a\u8fd9\u662f\u4f7f\u7528JWT\u7684\u6700\u5e38\u89c1\u65b9\u6848\u3002\u4e00\u65e6\u7528\u6237\u767b\u5f55\uff0c\u6bcf\u4e2a\u540e\u7eed\u8bf7\u6c42\u5c06\u5305\u62ecJWT\uff0c\u4ece\u800c\u5141\u8bb8\u7528\u6237\u8bbf\u95ee\u8be5\u4ee4\u724c\u5141\u8bb8\u7684\u8def\u7531\uff0c\u670d\u52a1\u548c\u8d44\u6e90\u3002\u5355\u4e00\u767b\u5f55\u662f\u5f53\u4eca\u5e7f\u6cdb\u4f7f\u7528JWT\u7684\u4e00\u9879\u529f\u80fd\uff0c\u56e0\u4e3a\u5b83\u7684\u5f00\u9500\u5f88\u5c0f\u5e76\u4e14\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u57df\u4e2d\u8f7b\u677e\u4f7f\u7528\u3002")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u4fe1\u606f\u4ea4\u6362\uff1aJSON Web\u4ee4\u724c\u662f\u5728\u5404\u65b9\u4e4b\u95f4\u5b89\u5168\u5730\u4f20\u8f93\u4fe1\u606f\u7684\u4e00\u79cd\u597d\u65b9\u6cd5\u3002\u56e0\u4e3a\u53ef\u4ee5\u5bf9JWT\u8fdb\u884c\u7b7e\u540d\uff08\u4f8b\u5982\uff0c\u4f7f\u7528\u516c\u94a5/\u79c1\u94a5\u5bf9\uff09\uff0c\u6240\u4ee5\u60a8\u53ef\u4ee5\u786e\u4fdd\u53d1\u4ef6\u4eba\u662f\u4ed6\u4eec\u6240\u8bf4\u7684\u4eba\u3002\u6b64\u5916\uff0c\u7531\u4e8e\u7b7e\u540d\u662f\u4f7f\u7528\u6807\u5934\u548c\u6709\u6548\u8d1f\u8f7d\u8ba1\u7b97\u7684\uff0c\u56e0\u6b64\u60a8\u8fd8\u53ef\u4ee5\u9a8c\u8bc1\u5185\u5bb9\u662f\u5426\u672a\u88ab\u7be1\u6539\u3002"))),(0,l.kt)("h3",{id:"\u4e3a\u4ec0\u4e48\u8981\u4f7f\u7528json-web\u4ee4\u724c"},"\u4e3a\u4ec0\u4e48\u8981\u4f7f\u7528JSON Web\u4ee4\u724c"),(0,l.kt)("p",null,"\u7531\u4e8eJSON\u4e0d\u5982XML\u5197\u957f\uff0c\u56e0\u6b64\u5728\u7f16\u7801\u65f6JSON\u7684\u5927\u5c0f\u4e5f\u8f83\u5c0f\uff0c\u4ece\u800c\u4f7fJWT\u6bd4SAML\u66f4\u4e3a\u7d27\u51d1\u3002\u8fd9\u4f7f\u5f97JWT\u662f\u5728HTML\u548cHTTP\u73af\u5883\u4e2d\u4f20\u9012\u7684\u4e0d\u9519\u7684\u9009\u62e9\u3002"),(0,l.kt)("p",null,"\u5728\u5b89\u5168\u65b9\u9762\uff0c\u53ea\u80fd\u4f7f\u7528HMAC\u7b97\u6cd5\u7531\u5171\u4eab\u673a\u5bc6\u5bf9SWT\u8fdb\u884c\u5bf9\u79f0\u7b7e\u540d\u3002\u4f46\u662f\uff0cJWT\u548cSAML\u4ee4\u724c\u53ef\u4ee5\u4f7f\u7528X.509\u8bc1\u4e66\u5f62\u5f0f\u7684\u516c\u7528/\u4e13\u7528\u5bc6\u94a5\u5bf9\u8fdb\u884c\u7b7e\u540d\u3002\u4e0e\u7b7e\u7f72JSON\u7684\u7b80\u5355\u6027\u76f8\u6bd4\uff0c\u4f7f\u7528XML Digital Signature\u7b7e\u7f72XML\u800c\u4e0d\u5f15\u5165\u6a21\u7cca\u7684\u5b89\u5168\u6f0f\u6d1e\u662f\u975e\u5e38\u56f0\u96be\u7684\u3002"),(0,l.kt)("p",null,"JSON\u89e3\u6790\u5668\u5728\u5927\u591a\u6570\u7f16\u7a0b\u8bed\u8a00\u4e2d\u90fd\u5f88\u5e38\u89c1\uff0c\u56e0\u4e3a\u5b83\u4eec\u76f4\u63a5\u6620\u5c04\u5230\u5bf9\u8c61\u3002\u76f8\u53cd\uff0cXML\u6ca1\u6709\u81ea\u7136\u7684\u6587\u6863\u5230\u5bf9\u8c61\u7684\u6620\u5c04\u3002\u4e0eSAML\u65ad\u8a00\u76f8\u6bd4\uff0c\u8fd9\u4f7f\u4f7f\u7528JWT\u66f4\u52a0\u5bb9\u6613\u3002"),(0,l.kt)("p",null,"\u5173\u4e8e\u7528\u6cd5\uff0cJWT\u662f\u5728Internet\u89c4\u6a21\u4e0a\u4f7f\u7528\u7684\u3002\u8fd9\u7a81\u663e\u4e86\u5728\u591a\u4e2a\u5e73\u53f0\uff08\u5c24\u5176\u662f\u79fb\u52a8\u5e73\u53f0\uff09\u4e0a\u5bf9JSON Web\u4ee4\u724c\u8fdb\u884c\u5ba2\u6237\u7aef\u5904\u7406\u7684\u7b80\u4fbf\u6027\u3002"),(0,l.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"\u4ee5\u4e0a\u5185\u5bb9\u5168\u90e8\u6765\u81ea",(0,l.kt)("a",{parentName:"p",href:"https://jwt.io/introduction"},"jwt\u5b98\u7f51\u4ecb\u7ecd")))),(0,l.kt)("h3",{id:"go-zero\u4e2d\u600e\u4e48\u4f7f\u7528jwt"},"go-zero\u4e2d\u600e\u4e48\u4f7f\u7528jwt"),(0,l.kt)("p",null,"jwt\u9274\u6743\u4e00\u822c\u5728api\u5c42\u4f7f\u7528\uff0c\u6211\u4eec\u8fd9\u6b21\u6f14\u793a\u5de5\u7a0b\u4e2d\u5206\u522b\u5728user api\u767b\u5f55\u65f6\u751f\u6210jwt token\uff0c\u5728search api\u67e5\u8be2\u56fe\u4e66\u65f6\u9a8c\u8bc1\u7528\u6237jwt token\u4e24\u6b65\u6765\u5b9e\u73b0\u3002"),(0,l.kt)("h4",{id:"user-api\u751f\u6210jwt-token"},"user api\u751f\u6210jwt token"),(0,l.kt)("p",null,"\u63a5\u7740",(0,l.kt)("a",{parentName:"p",href:"/docs/project/business"},"\u4e1a\u52a1\u7f16\u7801"),"\u7ae0\u8282\u7684\u5185\u5bb9\uff0c\u6211\u4eec\u5b8c\u5584\u4e0a\u4e00\u8282\u9057\u7559\u7684",(0,l.kt)("inlineCode",{parentName:"p"},"getJwtToken"),"\u65b9\u6cd5\uff0c\u5373\u751f\u6210jwt token\u903b\u8f91"),(0,l.kt)("h5",{id:"\u6dfb\u52a0\u914d\u7f6e\u5b9a\u4e49\u548cyaml\u914d\u7f6e\u9879"},"\u6dfb\u52a0\u914d\u7f6e\u5b9a\u4e49\u548cyaml\u914d\u7f6e\u9879"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/cmd/api/internal/config/config.go\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},"type Config struct {\n    rest.RestConf\n    Mysql struct{\n        DataSource string\n    }\n    CacheRedis cache.CacheConf\n    Auth      struct {\n        AccessSecret string\n        AccessExpire int64\n    }\n}\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/cmd/api/etc/user-api.yaml\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"Name: user-api\nHost: 0.0.0.0\nPort: 8888\nMysql:\n  DataSource: $user:$password@tcp($url)/$db?charset=utf8mb4&parseTime=true&loc=Asia%2FShanghai\nCacheRedis:\n  - Host: $host\n    Pass: $pass\n    Type: node\nAuth:\n  AccessSecret: $AccessSecret\n  AccessExpire: $AccessExpire\n")),(0,l.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"$AccessSecret\uff1a\u751f\u6210jwt token\u7684\u5bc6\u94a5\uff0c\u6700\u7b80\u5355\u7684\u65b9\u5f0f\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2auuid\u503c\u3002"),(0,l.kt)("p",{parentName:"div"},"$AccessExpire\uff1ajwt token\u6709\u6548\u671f\uff0c\u5355\u4f4d\uff1a\u79d2"))),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/cmd/api/internal/logic/loginlogic.go\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func (l *LoginLogic) getJwtToken(secretKey string, iat, seconds, userId int64) (string, error) {\n  claims := make(jwt.MapClaims)\n  claims["exp"] = iat + seconds\n  claims["iat"] = iat\n  claims["userId"] = userId\n  token := jwt.New(jwt.SigningMethodHS256)\n  token.Claims = claims\n  return token.SignedString([]byte(secretKey))\n}\n')),(0,l.kt)("h4",{id:"search-api\u4f7f\u7528jwt-token\u9274\u6743"},"search api\u4f7f\u7528jwt token\u9274\u6743"),(0,l.kt)("h5",{id:"\u7f16\u5199searchapi\u6587\u4ef6"},"\u7f16\u5199search.api\u6587\u4ef6"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/cmd/api/search.api\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-text"},'type (\n    SearchReq {\n        // \u56fe\u4e66\u540d\u79f0\n        Name string `form:"name"`\n    }\n\n    SearchReply {\n        Name string `json:"name"`\n        Count int `json:"count"`\n    }\n)\n\n@server(\n    jwt: Auth\n)\nservice search-api {\n    @handler search\n    get /search/do (SearchReq) returns (SearchReply)\n}\n\nservice search-api {\n    @handler ping\n    get /search/ping\n}\n')),(0,l.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},(0,l.kt)("inlineCode",{parentName:"p"},"jwt: Auth"),"\uff1a\u5f00\u542fjwt\u9274\u6743"),(0,l.kt)("p",{parentName:"div"},"\u5982\u679c\u8def\u7531\u9700\u8981jwt\u9274\u6743\uff0c\u5219\u9700\u8981\u5728service\u4e0a\u65b9\u58f0\u660e\u6b64\u8bed\u6cd5\u6807\u5fd7\uff0c\u5982\u4e0a\u6587\u4e2d\u7684",(0,l.kt)("inlineCode",{parentName:"p"}," /search/do")),(0,l.kt)("p",{parentName:"div"},"\u4e0d\u9700\u8981jwt\u9274\u6743\u7684\u8def\u7531\u5c31\u65e0\u9700\u58f0\u660e\uff0c\u5982\u4e0a\u6587\u4e2d",(0,l.kt)("inlineCode",{parentName:"p"},"/search/ping")))),(0,l.kt)("h5",{id:"\u751f\u6210\u4ee3\u7801"},"\u751f\u6210\u4ee3\u7801"),(0,l.kt)("p",null,"\u524d\u9762\u5df2\u7ecf\u63cf\u8ff0\u8fc7\u6709\u4e09\u79cd\u65b9\u5f0f\u53bb\u751f\u6210\u4ee3\u7801\uff0c\u8fd9\u91cc\u5c31\u4e0d\u8d58\u8ff0\u4e86\u3002"),(0,l.kt)("h5",{id:"\u6dfb\u52a0yaml\u914d\u7f6e\u9879"},"\u6dfb\u52a0yaml\u914d\u7f6e\u9879"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/cmd/api/etc/search-api.yaml\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"Name: search-api\nHost: 0.0.0.0\nPort: 8889\nAuth:\n  AccessSecret: $AccessSecret\n  AccessExpire: $AccessExpire\n\n")),(0,l.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"$AccessSecret\uff1a\u8fd9\u4e2a\u503c\u5fc5\u987b\u8981\u548cuser api\u4e2d\u58f0\u660e\u7684\u4e00\u81f4\u3002"),(0,l.kt)("p",{parentName:"div"}," $AccessExpire: \u6709\u6548\u671f"),(0,l.kt)("p",{parentName:"div"},"\u8fd9\u91cc\u4fee\u6539\u4e00\u4e0b\u7aef\u53e3\uff0c\u907f\u514d\u548cuser api\u7aef\u53e3",(0,l.kt)("inlineCode",{parentName:"p"},"8888"),"\u51b2\u7a81"))),(0,l.kt)("h4",{id:"\u9a8c\u8bc1-jwt-token"},"\u9a8c\u8bc1 jwt token"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u542f\u52a8user api\u670d\u52a1\uff0c\u767b\u5f55"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd service/user/cmd/api\n$ go run user.go -f etc/user-api.yaml\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-text"},"Starting server at 0.0.0.0:8888...\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ curl -i -X POST \\\n  http://127.0.0.1:8888/user/login \\\n  -H \'content-type: application/json\' \\\n  -d \'{\n    "username":"666",\n    "password":"123456"\n}\'\n')),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-text"},'HTTP/1.1 200 OK\nContent-Type: application/json\nDate: Mon, 08 Feb 2021 10:37:54 GMT\nContent-Length: 251\n\n{"id":1,"name":"\u5c0f\u660e","gender":"\u7537","accessToken":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTI4NjcwNzQsImlhdCI6MTYxMjc4MDY3NCwidXNlcklkIjoxfQ.JKa83g9BlEW84IiCXFGwP2aSd0xF3tMnxrOzVebbt80","accessExpire":1612867074,"refreshAfter":1612823874}\n'))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u542f\u52a8search api\u670d\u52a1\uff0c\u8c03\u7528",(0,l.kt)("inlineCode",{parentName:"p"},"/search/do"),"\u9a8c\u8bc1jwt\u9274\u6743\u662f\u5426\u901a\u8fc7"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ go run search.go -f etc/search-api.yaml\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-text"},"Starting server at 0.0.0.0:8889...\n")),(0,l.kt)("p",{parentName:"li"},"  \u6211\u4eec\u5148\u4e0d\u4f20jwt token\uff0c\u770b\u770b\u7ed3\u679c"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ curl -i -X GET \\\n  'http://127.0.0.1:8889/search/do?name=%E8%A5%BF%E6%B8%B8%E8%AE%B0'\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-text"},"HTTP/1.1 401 Unauthorized\nDate: Mon, 08 Feb 2021 10:41:57 GMT\nContent-Length: 0\n")),(0,l.kt)("p",{parentName:"li"},"  \u5f88\u660e\u663e\uff0cjwt\u9274\u6743\u5931\u8d25\u4e86\uff0c\u8fd4\u56de401\u7684statusCode\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5e26\u4e00\u4e0bjwt token\uff08\u5373\u7528\u6237\u767b\u5f55\u8fd4\u56de\u7684",(0,l.kt)("inlineCode",{parentName:"p"},"accessToken"),"\uff09"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ curl -i -X GET \\\n  'http://127.0.0.1:8889/search/do?name=%E8%A5%BF%E6%B8%B8%E8%AE%B0' \\\n  -H 'authorization: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTI4NjcwNzQsImlhdCI6MTYxMjc4MDY3NCwidXNlcklkIjoxfQ.JKa83g9BlEW84IiCXFGwP2aSd0xF3tMnxrOzVebbt80'\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-text"},'HTTP/1.1 200 OK\nContent-Type: application/json\nDate: Mon, 08 Feb 2021 10:44:45 GMT\nContent-Length: 21\n\n{"name":"","count":0}\n')))),(0,l.kt)("p",null,"\u81f3\u6b64\uff0cjwt\u4ece\u751f\u6210\u5230\u4f7f\u7528\u5c31\u6f14\u793a\u5b8c\u6210\u4e86\uff0cjwt token\u7684\u9274\u6743\u662fgo-zero\u5185\u90e8\u5df2\u7ecf\u5c01\u88c5\u4e86\uff0c\u4f60\u53ea\u9700\u5728api\u6587\u4ef6\u4e2d\u5b9a\u4e49\u670d\u52a1\u65f6\u7b80\u5355\u7684\u58f0\u660e\u4e00\u4e0b\u5373\u53ef\u3002"),(0,l.kt)("h4",{id:"\u83b7\u53d6jwt-token\u4e2d\u643a\u5e26\u7684\u4fe1\u606f"},"\u83b7\u53d6jwt token\u4e2d\u643a\u5e26\u7684\u4fe1\u606f"),(0,l.kt)("p",null,"go-zero\u4ecejwt token\u89e3\u6790\u540e\u4f1a\u5c06\u7528\u6237\u751f\u6210token\u65f6\u4f20\u5165\u7684kv\u539f\u5c01\u4e0d\u52a8\u7684\u653e\u5728http.Request\u7684Context\u4e2d\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7Context\u5c31\u53ef\u4ee5\u62ff\u5230\u4f60\u60f3\u8981\u7684\u503c"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim /service/search/cmd/api/internal/logic/searchlogic.go\n")),(0,l.kt)("p",null,"\u6dfb\u52a0\u4e00\u4e2alog\u6765\u8f93\u51fa\u4ecejwt\u89e3\u6790\u51fa\u6765\u7684userId\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func (l *SearchLogic) Search(req types.SearchReq) (*types.SearchReply, error) {\n    logx.Infof("userId: %v",l.ctx.Value("userId"))// \u8fd9\u91cc\u7684key\u548c\u751f\u6210jwt token\u65f6\u4f20\u5165\u7684key\u4e00\u81f4\n    return &types.SearchReply{}, nil\n}\n')),(0,l.kt)("p",null,"\u8fd0\u884c\u7ed3\u679c"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-text"},'{"@timestamp":"2021-02-09T10:29:09.399+08","level":"info","content":"userId: 1"}\n')),(0,l.kt)("h2",{id:"\u4e2d\u95f4\u4ef6\u4f7f\u7528"},"\u4e2d\u95f4\u4ef6\u4f7f\u7528"),(0,l.kt)("p",null,"\u5728\u4e0a\u4e00\u8282\uff0c\u6211\u4eec\u6f14\u793a\u4e86\u600e\u4e48\u4f7f\u7528jwt\u9274\u6743\uff0c\u76f8\u4fe1\u4f60\u5df2\u7ecf\u638c\u63e1\u4e86\u5bf9jwt\u7684\u57fa\u672c\u4f7f\u7528\uff0c\u672c\u8282\u6211\u4eec\u6765\u770b\u4e00\u4e0bapi\u670d\u52a1\u4e2d\u95f4\u4ef6\u600e\u4e48\u4f7f\u7528\u3002"),(0,l.kt)("h3",{id:"\u4e2d\u95f4\u4ef6\u5206\u7c7b"},"\u4e2d\u95f4\u4ef6\u5206\u7c7b"),(0,l.kt)("p",null,"\u5728go-zero\u4e2d\uff0c\u4e2d\u95f4\u4ef6\u53ef\u4ee5\u5206\u4e3a\u8def\u7531\u4e2d\u95f4\u4ef6\u548c\u5168\u5c40\u4e2d\u95f4\u4ef6\uff0c\u8def\u7531\u4e2d\u95f4\u4ef6\u662f\u6307\u67d0\u4e00\u4e9b\u7279\u5b9a\u8def\u7531\u9700\u8981\u5b9e\u73b0\u4e2d\u95f4\u4ef6\u903b\u8f91\uff0c\u5176\u548cjwt\u7c7b\u4f3c\uff0c\u6ca1\u6709\u653e\u5728",(0,l.kt)("inlineCode",{parentName:"p"},"jwt:xxx"),"\u4e0b\u7684\u8def\u7531\u4e0d\u4f1a\u4f7f\u7528\u4e2d\u95f4\u4ef6\u529f\u80fd\uff0c\n\u800c\u5168\u5c40\u4e2d\u95f4\u4ef6\u7684\u670d\u52a1\u8303\u56f4\u5219\u662f\u6574\u4e2a\u670d\u52a1\u3002"),(0,l.kt)("h3",{id:"\u4e2d\u95f4\u4ef6\u4f7f\u7528-1"},"\u4e2d\u95f4\u4ef6\u4f7f\u7528"),(0,l.kt)("p",null,"\u8fd9\u91cc\u4ee5",(0,l.kt)("inlineCode",{parentName:"p"},"search"),"\u670d\u52a1\u4e3a\u4f8b\u6765\u6f14\u793a\u4e2d\u95f4\u4ef6\u7684\u4f7f\u7528"),(0,l.kt)("h4",{id:"\u8def\u7531\u4e2d\u95f4\u4ef6"},"\u8def\u7531\u4e2d\u95f4\u4ef6"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u91cd\u65b0\u7f16\u5199",(0,l.kt)("inlineCode",{parentName:"p"},"search.api"),"\u6587\u4ef6\uff0c\u6dfb\u52a0",(0,l.kt)("inlineCode",{parentName:"p"},"middleware"),"\u58f0\u660e"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd service/search/cmd/api\n$ vim search.api\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-text"},"type SearchReq struct {}\n\ntype SearchReply struct {}\n\n@server(\n    jwt: Auth\n    middleware: Example // \u8def\u7531\u4e2d\u95f4\u4ef6\u58f0\u660e\n)\nservice search-api {\n    @handler search\n    get /search/do (SearchReq) returns (SearchReply)\n}\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u91cd\u65b0\u751f\u6210api\u4ee3\u7801"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ goctl api go -api search.api -dir . \n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-text"},"etc/search-api.yaml exists, ignored generation\ninternal/config/config.go exists, ignored generation\nsearch.go exists, ignored generation\ninternal/svc/servicecontext.go exists, ignored generation\ninternal/handler/searchhandler.go exists, ignored generation\ninternal/handler/pinghandler.go exists, ignored generation\ninternal/logic/searchlogic.go exists, ignored generation\ninternal/logic/pinglogic.go exists, ignored generation\nDone.\n")),(0,l.kt)("p",{parentName:"li"},"  \u751f\u6210\u5b8c\u540e\u4f1a\u5728",(0,l.kt)("inlineCode",{parentName:"p"},"internal"),"\u76ee\u5f55\u4e0b\u591a\u4e00\u4e2a",(0,l.kt)("inlineCode",{parentName:"p"},"middleware"),"\u7684\u76ee\u5f55\uff0c\u8fd9\u91cc\u5373\u4e2d\u95f4\u4ef6\u6587\u4ef6\uff0c\u540e\u7eed\u4e2d\u95f4\u4ef6\u7684\u5b9e\u73b0\u903b\u8f91\u4e5f\u5728\u8fd9\u91cc\u7f16\u5199\u3002")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u5b8c\u5584\u8d44\u6e90\u4f9d\u8d56",(0,l.kt)("inlineCode",{parentName:"p"},"ServiceContext")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/cmd/api/internal/svc/servicecontext.go\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-go"},"type ServiceContext struct {\n    Config config.Config\n    Example rest.Middleware\n}\n\nfunc NewServiceContext(c config.Config) *ServiceContext {\n    return &ServiceContext{\n        Config: c,\n        Example: middleware.NewExampleMiddleware().Handle,\n    }\n}\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u7f16\u5199\u4e2d\u95f4\u4ef6\u903b\u8f91\n\u8fd9\u91cc\u4ec5\u6dfb\u52a0\u4e00\u884c\u65e5\u5fd7\uff0c\u5185\u5bb9example middle\uff0c\u5982\u679c\u670d\u52a1\u8fd0\u884c\u8f93\u51faexample middle\u5219\u4ee3\u8868\u4e2d\u95f4\u4ef6\u4f7f\u7528\u8d77\u6765\u4e86\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/cmd/api/internal/middleware/examplemiddleware.go\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-go"},'package middleware\n\nimport "net/http"\n\ntype ExampleMiddleware struct {\n}\n\nfunc NewExampleMiddleware() *ExampleMiddleware {\n        return &ExampleMiddleware{}\n}\n\nfunc (m *ExampleMiddleware) Handle(next http.HandlerFunc) http.HandlerFunc {\n    return func(w http.ResponseWriter, r *http.Request) {\n        // TODO generate middleware implement function, delete after code implementation\n\n        // Passthrough to next handler if need\n        next(w, r)\n    }\n}\n'))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u542f\u52a8\u670d\u52a1\u9a8c\u8bc1"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-text"},'{"@timestamp":"2021-02-09T11:32:57.931+08","level":"info","content":"example middle"}\n')))),(0,l.kt)("h4",{id:"\u5168\u5c40\u4e2d\u95f4\u4ef6"},"\u5168\u5c40\u4e2d\u95f4\u4ef6"),(0,l.kt)("p",null,"\u901a\u8fc7rest.Server\u63d0\u4f9b\u7684Use\u65b9\u6cd5\u5373\u53ef"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func main() {\n    flag.Parse()\n\n    var c config.Config\n    conf.MustLoad(*configFile, &c)\n\n    ctx := svc.NewServiceContext(c)\n    server := rest.MustNewServer(c.RestConf)\n    defer server.Stop()\n\n    // \u5168\u5c40\u4e2d\u95f4\u4ef6\n    server.Use(func(next http.HandlerFunc) http.HandlerFunc {\n        return func(w http.ResponseWriter, r *http.Request) {\n            logx.Info("global middleware")\n            next(w, r)\n        }\n    })\n    handler.RegisterHandlers(server, ctx)\n\n    fmt.Printf("Starting server at %s:%d...\\n", c.Host, c.Port)\n    server.Start()\n}\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-text"},'{"@timestamp":"2021-02-09T11:50:15.388+08","level":"info","content":"global middleware"}\n')),(0,l.kt)("h4",{id:"\u5728\u4e2d\u95f4\u4ef6\u91cc\u8c03\u7528\u5176\u5b83\u670d\u52a1"},"\u5728\u4e2d\u95f4\u4ef6\u91cc\u8c03\u7528\u5176\u5b83\u670d\u52a1"),(0,l.kt)("p",null,"\u901a\u8fc7\u95ed\u5305\u7684\u65b9\u5f0f\u628a\u5176\u5b83\u670d\u52a1\u4f20\u9012\u7ed9\u4e2d\u95f4\u4ef6\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'// \u6a21\u62df\u7684\u5176\u5b83\u670d\u52a1\ntype AnotherService struct{}\n\nfunc (s *AnotherService) GetToken() string {\n    return stringx.Rand()\n}\n\n// \u5e38\u89c4\u4e2d\u95f4\u4ef6\nfunc middleware(next http.HandlerFunc) http.HandlerFunc {\n    return func(w http.ResponseWriter, r *http.Request) {\n        w.Header().Add("X-Middleware", "static-middleware")\n        next(w, r)\n    }\n}\n\n// \u8c03\u7528\u5176\u5b83\u670d\u52a1\u7684\u4e2d\u95f4\u4ef6\nfunc middlewareWithAnotherService(s *AnotherService) rest.Middleware {\n    return func(next http.HandlerFunc) http.HandlerFunc {\n        return func(w http.ResponseWriter, r *http.Request) {\n            w.Header().Add("X-Middleware", s.GetToken())\n            next(w, r)\n        }\n    }\n}\n')),(0,l.kt)("p",null,"\u5b8c\u6574\u4ee3\u7801\u53c2\u8003\uff1a",(0,l.kt)("a",{parentName:"p",href:"https://github.com/zeromicro/zero-examples/tree/main/http/middleware"},"https://github.com/zeromicro/zero-examples/tree/main/http/middleware")),(0,l.kt)("h2",{id:"rpc\u7f16\u5199\u4e0e\u8c03\u7528"},"rpc\u7f16\u5199\u4e0e\u8c03\u7528"),(0,l.kt)("p",null,"\u5728\u4e00\u4e2a\u5927\u7684\u7cfb\u7edf\u4e2d\uff0c\u591a\u4e2a\u5b50\u7cfb\u7edf\uff08\u670d\u52a1\uff09\u95f4\u5fc5\u7136\u5b58\u5728\u6570\u636e\u4f20\u9012\uff0c\u6709\u6570\u636e\u4f20\u9012\u5c31\u9700\u8981\u901a\u4fe1\u65b9\u5f0f\uff0c\u4f60\u53ef\u4ee5\u9009\u62e9\u6700\u7b80\u5355\u7684http\u8fdb\u884c\u901a\u4fe1\uff0c\u4e5f\u53ef\u4ee5\u9009\u62e9rpc\u670d\u52a1\u8fdb\u884c\u901a\u4fe1\uff0c\n\u5728go-zero\uff0c\u6211\u4eec\u4f7f\u7528zrpc\u6765\u8fdb\u884c\u670d\u52a1\u95f4\u7684\u901a\u4fe1\uff0czrpc\u662f\u57fa\u4e8egrpc\u3002"),(0,l.kt)("h3",{id:"\u573a\u666f-1"},"\u573a\u666f"),(0,l.kt)("p",null,"\u5728\u524d\u9762\u6211\u4eec\u5b8c\u5584\u4e86\u5bf9\u7528\u6237\u8fdb\u884c\u767b\u5f55\uff0c\u7528\u6237\u67e5\u8be2\u56fe\u4e66\u7b49\u63a5\u53e3\u534f\u8bae\uff0c\u4f46\u662f\u7528\u6237\u5728\u67e5\u8be2\u56fe\u4e66\u65f6\u6ca1\u6709\u505a\u4efb\u4f55\u7528\u6237\u6821\u9a8c\uff0c\u5982\u679c\u5f53\u524d\u7528\u6237\u662f\u4e00\u4e2a\u4e0d\u5b58\u5728\u7684\u7528\u6237\u5219\u6211\u4eec\u4e0d\u5141\u8bb8\u5176\u67e5\u9605\u56fe\u4e66\u4fe1\u606f\uff0c\n\u4ece\u4e0a\u6587\u4fe1\u606f\u6211\u4eec\u53ef\u4ee5\u5f97\u77e5\uff0c\u9700\u8981user\u670d\u52a1\u63d0\u4f9b\u4e00\u4e2a\u65b9\u6cd5\u6765\u83b7\u53d6\u7528\u6237\u4fe1\u606f\u4f9bsearch\u670d\u52a1\u4f7f\u7528\uff0c\u56e0\u6b64\u6211\u4eec\u5c31\u9700\u8981\u521b\u5efa\u4e00\u4e2auser rpc\u670d\u52a1\uff0c\u5e76\u63d0\u4f9b\u4e00\u4e2agetUser\u65b9\u6cd5\u3002"),(0,l.kt)("h3",{id:"rpc\u670d\u52a1\u7f16\u5199"},"rpc\u670d\u52a1\u7f16\u5199"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u7f16\u8bd1proto\u6587\u4ef6")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/cmd/rpc/user.proto\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-protobuf"},'syntax = "proto3";\n\npackage user;\n\noption go_package = "user";\n\nmessage IdReq{\n  int64 id = 1;\n}\n\nmessage UserInfoReply{\n  int64 id = 1;\n  string name = 2;\n  string number = 3;\n  string gender = 4;\n}\n\nservice user {\n  rpc getUser(IdReq) returns(UserInfoReply);\n}\n')),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u751f\u6210rpc\u670d\u52a1\u4ee3\u7801")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd service/user/cmd/rpc\n$ goctl rpc proto -src user.proto -dir .\n")),(0,l.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"\u5982\u679c\u5b89\u88c5\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"protoc-gen-go")," \u7248\u5927\u4e8e1.4.0, proto\u6587\u4ef6\u5efa\u8bae\u52a0\u4e0a",(0,l.kt)("inlineCode",{parentName:"p"},"go_package")))),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u6dfb\u52a0\u914d\u7f6e\u53ca\u5b8c\u5584yaml\u914d\u7f6e\u9879")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/cmd/rpc/internal/config/config.go\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},"type Config struct {\n    zrpc.RpcServerConf\n    Mysql struct {\n        DataSource string\n    }\n    CacheRedis cache.CacheConf\n}\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim /service/user/cmd/rpc/etc/user.yaml\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"Name: user.rpc\nListenOn: 127.0.0.1:8080\nEtcd:\nHosts:\n- $etcdHost\n  Key: user.rpc\nMysql:\nDataSource: $user:$password@tcp($url)/$db?charset=utf8mb4&parseTime=true&loc=Asia%2FShanghai\nCacheRedis:\n- Host: $host\n  Pass: $pass\n  Type: node  \n")),(0,l.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"$user: mysql\u6570\u636e\u5e93user"),(0,l.kt)("p",{parentName:"div"},"$password: mysql\u6570\u636e\u5e93\u5bc6\u7801"),(0,l.kt)("p",{parentName:"div"},"$url: mysql\u6570\u636e\u5e93\u8fde\u63a5\u5730\u5740"),(0,l.kt)("p",{parentName:"div"},"$db: mysql\u6570\u636e\u5e93db\u540d\u79f0\uff0c\u5373user\u8868\u6240\u5728database"),(0,l.kt)("p",{parentName:"div"},"$host: redis\u8fde\u63a5\u5730\u5740 \u683c\u5f0f\uff1aip:port\uff0c\u5982:127.0.0.1:6379"),(0,l.kt)("p",{parentName:"div"},"$pass: redis\u5bc6\u7801"),(0,l.kt)("p",{parentName:"div"},"$etcdHost: etcd\u8fde\u63a5\u5730\u5740\uff0c\u683c\u5f0f\uff1aip:port\uff0c\u5982\uff1a 127.0.0.1:2379"))),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u6dfb\u52a0\u8d44\u6e90\u4f9d\u8d56",(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/cmd/rpc/internal/svc/servicecontext.go  \n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-go"},"type ServiceContext struct {\n    Config    config.Config\n    UserModel model.UserModel\n}\n\nfunc NewServiceContext(c config.Config) *ServiceContext {\n    conn := sqlx.NewMysql(c.Mysql.DataSource)\n    return &ServiceContext{\n        Config: c,\n        UserModel: model.NewUserModel(conn, c.CacheRedis),\n    }\n}\n"))),(0,l.kt)("li",{parentName:"ul"},"\u6dfb\u52a0rpc\u903b\u8f91",(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ service/user/cmd/rpc/internal/logic/getuserlogic.go\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-go"},"func (l *GetUserLogic) GetUser(in *user.IdReq) (*user.UserInfoReply, error) {\n    one, err := l.svcCtx.UserModel.FindOne(in.Id)\n    if err != nil {\n        return nil, err\n    }\n    \n    return &user.UserInfoReply{\n        Id:     one.Id,\n        Name:   one.Name,\n        Number: one.Number,\n        Gender: one.Gender,\n    }, nil\n}\n")))),(0,l.kt)("h3",{id:"\u4f7f\u7528rpc"},"\u4f7f\u7528rpc"),(0,l.kt)("p",null,"\u63a5\u4e0b\u6765\u6211\u4eec\u5728search\u670d\u52a1\u4e2d\u8c03\u7528user rpc"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u6dfb\u52a0UserRpc\u914d\u7f6e\u53cayaml\u914d\u7f6e\u9879",(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/cmd/api/internal/config/config.go\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-go"},"type Config struct {\n    rest.RestConf\n    Auth struct {\n        AccessSecret string\n        AccessExpire int64\n    }\n    UserRpc zrpc.RpcClientConf\n}\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/cmd/api/etc/search-api.yaml\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"Name: search-api\nHost: 0.0.0.0\nPort: 8889\nAuth:\n  AccessSecret: $AccessSecret\n  AccessExpire: $AccessExpire\nUserRpc:\n  Etcd:\n    Hosts:\n      - $etcdHost\n    Key: user.rpc\n")),"  :::tip\n$AccessSecret\uff1a\u8fd9\u4e2a\u503c\u5fc5\u987b\u8981\u548cuser api\u4e2d\u58f0\u660e\u7684\u4e00\u81f4\u3002","  $AccessExpire: \u6709\u6548\u671f","  $etcdHost\uff1a etcd\u8fde\u63a5\u5730\u5740","  etcd\u4e2d\u7684",(0,l.kt)("inlineCode",{parentName:"li"},"Key"),"\u5fc5\u987b\u8981\u548cuser rpc\u670d\u52a1\u914d\u7f6e\u4e2dKey\u4e00\u81f4\n:::"),(0,l.kt)("li",{parentName:"ul"},"\u6dfb\u52a0\u4f9d\u8d56",(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/cmd/api/internal/svc/servicecontext.go\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-go"},"type ServiceContext struct {\n    Config  config.Config\n    Example rest.Middleware\n    UserRpc userclient.User\n}\n\nfunc NewServiceContext(c config.Config) *ServiceContext {\n    return &ServiceContext{\n        Config:  c,\n        Example: middleware.NewExampleMiddleware().Handle,\n        UserRpc: userclient.NewUser(zrpc.MustNewClient(c.UserRpc)),\n    }\n}\n"))),(0,l.kt)("li",{parentName:"ul"},"\u8865\u5145\u903b\u8f91",(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim /service/search/cmd/api/internal/logic/searchlogic.go\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func (l *SearchLogic) Search(req types.SearchReq) (*types.SearchReply, error) {\n    userIdNumber := json.Number(fmt.Sprintf("%v", l.ctx.Value("userId")))\n    logx.Infof("userId: %s", userIdNumber)\n    userId, err := userIdNumber.Int64()\n    if err != nil {\n        return nil, err\n    }\n    \n    // \u4f7f\u7528user rpc\n    _, err = l.svcCtx.UserRpc.GetUser(l.ctx, &userclient.IdReq{\n        Id: userId,\n    })\n    if err != nil {\n        return nil, err\n    }\n\n    return &types.SearchReply{\n        Name:  req.Name,\n        Count: 100,\n    }, nil\n}\n')))),(0,l.kt)("h3",{id:"\u542f\u52a8\u5e76\u9a8c\u8bc1\u670d\u52a1"},"\u542f\u52a8\u5e76\u9a8c\u8bc1\u670d\u52a1"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u542f\u52a8etcd\u3001redis\u3001mysql"),(0,l.kt)("li",{parentName:"ul"},"\u542f\u52a8user rpc",(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd /service/user/cmd/rpc\n$ go run user.go -f etc/user.yaml\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-text"},"Starting rpc server at 127.0.0.1:8080...\n"))),(0,l.kt)("li",{parentName:"ul"},"\u542f\u52a8search api")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd service/search/cmd/api\n$ go run search.go -f etc/search-api.yaml\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u9a8c\u8bc1\u670d\u52a1",(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ curl -i -X GET \\\n  'http://127.0.0.1:8889/search/do?name=%E8%A5%BF%E6%B8%B8%E8%AE%B0' \\\n  -H 'authorization: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTI4NjcwNzQsImlhdCI6MTYxMjc4MDY3NCwidXNlcklkIjoxfQ.JKa83g9BlEW84IiCXFGwP2aSd0xF3tMnxrOzVebbt80'\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-text"},'HTTP/1.1 200 OK\nContent\n-Type: application/json\nDate: Tue, 09 Feb 2021 06:05:52 GMT\nContent-Length: 32\n\n{"name":"\u897f\u6e38\u8bb0","count":100}\n')))),(0,l.kt)("h2",{id:"\u9519\u8bef\u5904\u7406"},"\u9519\u8bef\u5904\u7406"),(0,l.kt)("p",null,"\u9519\u8bef\u7684\u5904\u7406\u662f\u4e00\u4e2a\u670d\u52a1\u5fc5\u4e0d\u53ef\u7f3a\u7684\u73af\u8282\u3002\u5728\u5e73\u65f6\u7684\u4e1a\u52a1\u5f00\u53d1\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba4\u4e3ahttp\u72b6\u6001\u7801\u4e0d\u4e3a",(0,l.kt)("inlineCode",{parentName:"p"},"2xx"),"\u7cfb\u5217\u7684\uff0c\u90fd\u53ef\u4ee5\u8ba4\u4e3a\u662fhttp\u8bf7\u6c42\u9519\u8bef\uff0c\n\u5e76\u4f34\u968f\u54cd\u5e94\u7684\u9519\u8bef\u4fe1\u606f\uff0c\u4f46\u8fd9\u4e9b\u9519\u8bef\u4fe1\u606f\u90fd\u662f\u4ee5plain text\u5f62\u5f0f\u8fd4\u56de\u7684\u3002\u9664\u6b64\u4e4b\u5916\uff0c\u6211\u5728\u4e1a\u52a1\u4e2d\u8fd8\u4f1a\u5b9a\u4e49\u4e00\u4e9b\u4e1a\u52a1\u6027\u9519\u8bef\uff0c\u5e38\u7528\u505a\u6cd5\u90fd\u662f\u901a\u8fc7\n",(0,l.kt)("inlineCode",{parentName:"p"},"code"),"\u3001",(0,l.kt)("inlineCode",{parentName:"p"},"msg")," \u4e24\u4e2a\u5b57\u6bb5\u6765\u8fdb\u884c\u4e1a\u52a1\u5904\u7406\u7ed3\u679c\u63cf\u8ff0\uff0c\u5e76\u4e14\u5e0c\u671b\u80fd\u591f\u4ee5json\u54cd\u5e94\u4f53\u6765\u8fdb\u884c\u54cd\u5e94\u3002"),(0,l.kt)("h3",{id:"\u4e1a\u52a1\u9519\u8bef\u54cd\u5e94\u683c\u5f0f"},"\u4e1a\u52a1\u9519\u8bef\u54cd\u5e94\u683c\u5f0f"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u4e1a\u52a1\u5904\u7406\u6b63\u5e38"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "code": 0,\n  "msg": "successful",\n  "data": {\n    ....\n  }\n}\n'))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u4e1a\u52a1\u5904\u7406\u5f02\u5e38"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "code": 10001,\n  "msg": "\u53c2\u6570\u9519\u8bef"\n}\n')))),(0,l.kt)("h3",{id:"user-api\u4e4blogin"},"user api\u4e4blogin"),(0,l.kt)("p",null,"\u5728\u4e4b\u524d\uff0c\u6211\u4eec\u5728\u767b\u5f55\u903b\u8f91\u4e2d\u5904\u7406\u7528\u6237\u540d\u4e0d\u5b58\u5728\u65f6\uff0c\u76f4\u63a5\u8fd4\u56de\u6765\u4e00\u4e2aerror\u3002\u6211\u4eec\u6765\u767b\u5f55\u5e76\u4f20\u9012\u4e00\u4e2a\u4e0d\u5b58\u5728\u7684\u7528\u6237\u540d\u770b\u770b\u6548\u679c\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'curl -X POST \\\n  http://127.0.0.1:8888/user/login \\\n  -H \'content-type: application/json\' \\\n  -d \'{\n    "username":"1",\n    "password":"123456"\n}\'\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-text"},"HTTP/1.1 400 Bad Request\nContent-Type: text/plain; charset=utf-8\nX-Content-Type-Options: nosniff\nDate: Tue, 09 Feb 2021 06:38:42 GMT\nContent-Length: 19\n\n\u7528\u6237\u540d\u4e0d\u5b58\u5728\n")),(0,l.kt)("p",null,"\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u5176\u4ee5json\u683c\u5f0f\u8fdb\u884c\u8fd4\u56de"),(0,l.kt)("h3",{id:"\u81ea\u5b9a\u4e49\u9519\u8bef"},"\u81ea\u5b9a\u4e49\u9519\u8bef"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u9996\u5148\u5728common\u4e2d\u6dfb\u52a0\u4e00\u4e2a",(0,l.kt)("inlineCode",{parentName:"p"},"baseerror.go"),"\u6587\u4ef6\uff0c\u5e76\u586b\u5165\u4ee3\u7801"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd common\n$ mkdir errorx&&cd errorx\n$ vim baseerror.go\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-goalng"},'package errorx\n\nconst defaultCode = 1001\n\ntype CodeError struct {\n    Code int    `json:"code"`\n    Msg  string `json:"msg"`\n}\n\ntype CodeErrorResponse struct {\n    Code int    `json:"code"`\n    Msg  string `json:"msg"`\n}\n\nfunc NewCodeError(code int, msg string) error {\n    return &CodeError{Code: code, Msg: msg}\n}\n\nfunc NewDefaultError(msg string) error {\n    return NewCodeError(defaultCode, msg)\n}\n\nfunc (e *CodeError) Error() string {\n    return e.Msg\n}\n\nfunc (e *CodeError) Data() *CodeErrorResponse {\n    return &CodeErrorResponse{\n        Code: e.Code,\n        Msg:  e.Msg,\n    }\n}\n\n'))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u5c06\u767b\u5f55\u903b\u8f91\u4e2d\u9519\u8bef\u7528CodeError\u81ea\u5b9a\u4e49\u9519\u8bef\u66ff\u6362"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-go"},'if len(strings.TrimSpace(req.Username)) == 0 || len(strings.TrimSpace(req.Password)) == 0 {\n        return nil, errorx.NewDefaultError("\u53c2\u6570\u9519\u8bef")\n    }\n\n    userInfo, err := l.svcCtx.UserModel.FindOneByNumber(req.Username)\n    switch err {\n    case nil:\n    case model.ErrNotFound:\n        return nil, errorx.NewDefaultError("\u7528\u6237\u540d\u4e0d\u5b58\u5728")\n    default:\n        return nil, err\n    }\n\n    if userInfo.Password != req.Password {\n        return nil, errorx.NewDefaultError("\u7528\u6237\u5bc6\u7801\u4e0d\u6b63\u786e")\n    }\n\n    now := time.Now().Unix()\n    accessExpire := l.svcCtx.Config.Auth.AccessExpire\n    jwtToken, err := l.getJwtToken(l.svcCtx.Config.Auth.AccessSecret, now, l.svcCtx.Config.Auth.AccessExpire, userInfo.Id)\n    if err != nil {\n        return nil, err\n    }\n\n    return &types.LoginReply{\n        Id:           userInfo.Id,\n        Name:         userInfo.Name,\n        Gender:       userInfo.Gender,\n        AccessToken:  jwtToken,\n        AccessExpire: now + accessExpire,\n        RefreshAfter: now + accessExpire/2,\n    }, nil\n'))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u5f00\u542f\u81ea\u5b9a\u4e49\u9519\u8bef"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/cmd/api/user.go\n")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func main() {\n    flag.Parse()\n\n    var c config.Config\n    conf.MustLoad(*configFile, &c)\n\n    ctx := svc.NewServiceContext(c)\n    server := rest.MustNewServer(c.RestConf)\n    defer server.Stop()\n\n    handler.RegisterHandlers(server, ctx)\n\n    // \u81ea\u5b9a\u4e49\u9519\u8bef\n    httpx.SetErrorHandler(func(err error) (int, interface{}) {\n        switch e := err.(type) {\n        case *errorx.CodeError:\n            return http.StatusOK, e.Data()\n        default:\n            return http.StatusInternalServerError, nil\n        }\n    })\n\n    fmt.Printf("Starting server at %s:%d...\\n", c.Host, c.Port)\n    server.Start()\n}\n'))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u91cd\u542f\u670d\u52a1\u9a8c\u8bc1"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-shell"},'$ curl -i -X POST \\\n  http://127.0.0.1:8888/user/login \\\n  -H \'content-type: application/json\' \\\n  -d \'{\n        "username":"1",\n        "password":"123456"\n}\'\n')),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-text"},'HTTP/1.1 200 OK\nContent-Type: application/json\nDate: Tue, 09 Feb 2021 06:47:29 GMT\nContent-Length: 40\n\n{"code":1001,"msg":"\u7528\u6237\u540d\u4e0d\u5b58\u5728"}\n')))))}m.isMDXComponent=!0}}]);