"use strict";(self.webpackChunktmp=self.webpackChunktmp||[]).push([[4827],{3905:function(n,e,t){t.d(e,{Zo:function(){return l},kt:function(){return g}});var o=t(7294);function r(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function i(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(n);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,o)}return t}function a(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?i(Object(t),!0).forEach((function(e){r(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function c(n,e){if(null==n)return{};var t,o,r=function(n,e){if(null==n)return{};var t,o,r={},i=Object.keys(n);for(o=0;o<i.length;o++)t=i[o],e.indexOf(t)>=0||(r[t]=n[t]);return r}(n,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);for(o=0;o<i.length;o++)t=i[o],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(r[t]=n[t])}return r}var s=o.createContext({}),p=function(n){var e=o.useContext(s),t=e;return n&&(t="function"==typeof n?n(e):a(a({},e),n)),t},l=function(n){var e=p(n.components);return o.createElement(s.Provider,{value:e},n.children)},d={inlineCode:"code",wrapper:function(n){var e=n.children;return o.createElement(o.Fragment,{},e)}},m=o.forwardRef((function(n,e){var t=n.components,r=n.mdxType,i=n.originalType,s=n.parentName,l=c(n,["components","mdxType","originalType","parentName"]),m=p(t),g=r,u=m["".concat(s,".").concat(g)]||m[g]||d[g]||i;return t?o.createElement(u,a(a({ref:e},l),{},{components:t})):o.createElement(u,a({ref:e},l))}));function g(n,e){var t=arguments,r=e&&e.mdxType;if("string"==typeof n||r){var i=t.length,a=new Array(i);a[0]=m;var c={};for(var s in e)hasOwnProperty.call(e,s)&&(c[s]=e[s]);c.originalType=n,c.mdxType="string"==typeof n?n:r,a[1]=c;for(var p=2;p<i;p++)a[p]=t[p];return o.createElement.apply(null,a)}return o.createElement.apply(null,t)}m.displayName="MDXCreateElement"},6454:function(n,e,t){t.r(e),t.d(e,{frontMatter:function(){return c},contentTitle:function(){return s},metadata:function(){return p},toc:function(){return l},default:function(){return m}});var o=t(7462),r=t(3366),i=(t(7294),t(3905)),a=["components"],c={sidebar_position:24},s="go-zero \u5b9e\u73b0\u4e00\u4e2a\u4e2d\u53f0\u7cfb\u7edf",p={unversionedId:"extension/datacenter",id:"extension/datacenter",title:"go-zero \u5b9e\u73b0\u4e00\u4e2a\u4e2d\u53f0\u7cfb\u7edf",description:"\u4f5c\u8005\uff1aJack Luo",source:"@site/docs/extension/datacenter.md",sourceDirName:"extension",slug:"/extension/datacenter",permalink:"/docs/extension/datacenter",editUrl:"https://github.com/zeromicro/zero-doc/tree/main/website/docs/extension/datacenter.md",tags:[],version:"current",sidebarPosition:24,frontMatter:{sidebar_position:24},sidebar:"tutorialSidebar",previous:{title:"\u4f7f\u7528go-zero\u5f00\u53d1\u4e00\u4e2a\u65c5\u6e38\u7cfb\u7edfgo-zero-looklook",permalink:"/docs/extension/go-zero-looklook"},next:{title:"\u6d41\u6570\u636e\u5904\u7406\u5229\u5668",permalink:"/docs/extension/stream"}},l=[{value:"datacenter-api\u670d\u52a1",id:"datacenter-api\u670d\u52a1",children:[{value:"\u521b\u5efaapi\u6587\u4ef6",id:"\u521b\u5efaapi\u6587\u4ef6",children:[],level:3},{value:"\u5b9a\u4e49api\u670d\u52a1",id:"\u5b9a\u4e49api\u670d\u52a1",children:[],level:3},{value:"\u751f\u6210datacenter api\u670d\u52a1",id:"\u751f\u6210datacenter-api\u670d\u52a1",children:[],level:3}],level:2},{value:"CommonRpc\u670d\u52a1",id:"commonrpc\u670d\u52a1",children:[{value:"\u65b0\u5efa\u9879\u76ee\u76ee\u5f55",id:"\u65b0\u5efa\u9879\u76ee\u76ee\u5f55",children:[],level:3},{value:"goctl\u521b\u5efa\u6a21\u677f",id:"goctl\u521b\u5efa\u6a21\u677f",children:[],level:3},{value:"gotcl\u751f\u6210rpc\u670d\u52a1",id:"gotcl\u751f\u6210rpc\u670d\u52a1",children:[],level:3}],level:2},{value:"\u4f7f\u7528\u5fc3\u5f97",id:"\u4f7f\u7528\u5fc3\u5f97",children:[],level:2}],d={toc:l};function m(n){var e=n.components,t=(0,r.Z)(n,a);return(0,i.kt)("wrapper",(0,o.Z)({},d,t,{components:e,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"go-zero-\u5b9e\u73b0\u4e00\u4e2a\u4e2d\u53f0\u7cfb\u7edf"},"go-zero \u5b9e\u73b0\u4e00\u4e2a\u4e2d\u53f0\u7cfb\u7edf"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"\u4f5c\u8005\uff1aJack Luo"),(0,i.kt)("p",{parentName:"blockquote"},"\u539f\u6587\u8fde\u63a5\uff1a",(0,i.kt)("a",{parentName:"p",href:"https://www.cnblogs.com/jackluo/p/14148518.html"},"https://www.cnblogs.com/jackluo/p/14148518.html"))),(0,i.kt)("p",null,"[TOC]"),(0,i.kt)("p",null,"\u6700\u8fd1\u53d1\u73b0golang\u793e\u533a\u91cc\u51fa\u4e86\u4e00\u4e2a\u65b0\u661f\u7684\u5fae\u670d\u52a1\u6846\u67b6\uff0c\u6765\u81ea\u597d\u672a\u6765\uff0c\u5149\u770b\u8fd9\u4e2a\u540d\u5b57\uff0c\u5c31\u5f88\u6709\u5954\u5934\uff0c\u4e4b\u524d\uff0c\u4e5f\u53ea\u662f\u73a9\u8fc7go-micro\uff0c\u5176\u5b9e\u771f\u6b63\u7684\u8fd8\u6ca1\u6709\u5728\u9879\u76ee\u4e2d\u8fd0\u7528\u8fc7\uff0c\u53ea\u662f\u89c9\u5f97 \u5fae\u670d\u52a1\uff0cgrpc \u8fd9\u4e9b\u5f88\u9ad8\u5927\u5c1a\uff0c\u8fd8\u6ca1\u6709\u5728\u9879\u76ee\u4e2d\uff0c\u771f\u6b63\u7684\u73a9\u8fc7\uff0c\u6211\u770b\u4e86\u4e00\u4e0b\u5b98\u65b9\u63d0\u4f9b\u7684\u5de5\u5177\u771f\u7684\u5f88\u597d\u7528\uff0c\u53ea\u9700\u8981\u5b9a\u4e49\u597d\uff0c\u8212\u9002\u6587\u4ef6jia\u7ed3\u6784 \u90fd\u751f\u6210\u4e86\uff0c\u53ea\u9700\u8981\u5173\u5fc3\u4e1a\u52a1\uff0c\u52a0\u4e0a\u6700\u8fd1 \u6709\u4e2a\u6295\u7968\u7684\u6d3b\u52a8\uff0c\u52a0\u4e0a\u6700\u8fd1\u8fd9\u51e0\u5e74\u4e2d\u53f0\u4e5f\u6bd4\u8f83\u706b\uff0c\u6240\u4ee5\u51b3\u5b9a\u73a9\u4e00\u4e0b\uff0c"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"\u5f00\u6e90\u5730\u5740: ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/jackluo2012/datacenter"},"https://github.com/jackluo2012/datacenter"))),(0,i.kt)("p",null,"\u5148\u804a\u804a\u4e2d\u53f0\u67b6\u6784\u601d\u8def\u5427\uff1a"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://img2020.cnblogs.com/blog/203395/202012/203395-20201217094615171-335437652.jpg",alt:null})),(0,i.kt)("p",null,"\u4e2d\u53f0\u7684\u6982\u5ff5\u5927\u6982\u5c31\u662f\u628a\u4e00\u4e2a\u4e00\u4e2a\u7684app \u7edf\u4e00\u8d77\u6765\uff0c\u53cd\u6b63\u6211\u662f\u8fd9\u6837\u7406\u89e3\u7684\u3002"),(0,i.kt)("p",null,"\u5148\u804a\u7528\u6237\u670d\u52a1\u5427\uff0c\u73b0\u5728\u4e00\u4e2a\u516c\u53f8\u6709\u5f88\u591a\u7684\u516c\u4f17\u53f7\u3001\u5c0f\u7a0b\u5e8f\u3001\u5fae\u4fe1\u7684\u3001\u652f\u4ed8\u5b9d\u7684\uff0c\u8fd8\u6709 xxx xxx\uff0c\u5f88\u591a\u7684\u5e73\u53f0\uff0c\u6bcf\u6b21\u5f00\u53d1\u7684\u65f6\u5019\uff0c\u6211\u4eec\u603b\u662f\u9700\u8981\u505a\u7528\u6237\u767b\u9646\u7684\u670d\u52a1\uff0c\u4e0d\u505c\u7684\u590d\u5236\u4ee3\u7801\uff0c\u7136\u540e\u6211\u4eec\u5c31\u5728\u601d\u8003\u80fd\u4e0d\u80fd\u6709\u4e00\u5957\u72ec\u7acb\u7684\u7528\u6237\u670d\u52a1\uff0c\u53ea\u9700\u8981\u544a\u8bc9\u6211\u4f60\u9700\u8981\u4f20\u4e2a\u4f60\u8981\u767b\u9646\u7684\u5e73\u53f0(\u6bd4\u5982\u5fae\u4fe1)\uff0c\u5fae\u4fe1\u767b\u9646\uff0c\u9700\u8981\u7684\u662f\u5ba2\u6237\u7aef\u8fd4\u56de\u7ed9\u670d\u52a1\u7aef\u4e00\u4e2acode \uff0c\u7136\u540e\u670d\u52a1\u7aef\u62ff\u7740\u8fd9\u4e2acode\u53bb\u5fae\u4fe1\u83b7\u53d6\u7528\u6237\u4fe1\u606f\uff0c\u53cd\u6b63\u5927\u5bb6\u90fd\u660e\u767d\u3002"),(0,i.kt)("p",null,"\u6211\u4eec\u51b3\u5b9a\uff0c\u5c06\u6240\u6709\u7684\u4fe1\u606f\u5f04\u5230\u914d\u7f6e\u516c\u5171\u670d\u52a1\u4e2d\u53bb\uff0c\u91cc\u9762\u518d\u5b58\u5fae\u4fe1\u3001\u652f\u4ed8\u5b9d\u4ee5\u53ca\u5176\u5b83\u5e73\u53f0\u7684appid\u3001appkey\u3001\u8fd8\u6709\u652f\u4ed8\u7684appid\u3001appkey\uff0c\u8fd9\u6837\u5c31\u5199\u4e00\u5957\u3002"),(0,i.kt)("hr",null),(0,i.kt)("p",null,"\u6700\u540e\u8bf4\u8bf4\u5b9e\u73b0\u5427\uff0c\u6574\u4e2a\u5c31\u4e00\u4e2arepo\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u7f51\u5173\uff0c\u6211\u4eec\u7528\u7684\u662f: go-zero\u7684Api\u670d\u52a1"),(0,i.kt)("li",{parentName:"ul"},"\u5176\u5b83\u5b83\u7684\u662f\u670d\u52a1\uff0c\u6211\u4eec\u5c31\u662f\u7528\u7684go-zero\u7684rpc\u670d\u52a1")),(0,i.kt)("p",null,"\u770b\u4e0b\u76ee\u5f55\u7ed3\u6784"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://img2020.cnblogs.com/blog/203395/202012/203395-20201209110504600-317546535.png",alt:null})),(0,i.kt)("p",null,"\u6574\u4e2a\u9879\u76ee\u5b8c\u6210\uff0c\u6211\u4e00\u4e2a\u4eba\u64cd\u5200\uff0c\u5199\u4e861\u4e2a\u6765\u661f\u671f\uff0c\u6211\u5c31\u5b9e\u73b0\u4e86\u4e0a\u9762\u7684\u4e2d\u53f0\u7cfb\u7edf\u3002"),(0,i.kt)("h2",{id:"datacenter-api\u670d\u52a1"},"datacenter-api\u670d\u52a1"),(0,i.kt)("p",null,"\u5148\u770b\u5b98\u65b9\u6587\u6863 ",(0,i.kt)("a",{parentName:"p",href:"https://go-zero.dev/cn/"},"https://go-zero.dev/cn/")),(0,i.kt)("p",null,"\u6211\u4eec\u5148\u628a\u7f51\u5173\u642d\u5efa\u8d77\u6765\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"\u279c blogs mkdir datacenter && cd datacenter\n\u279c datacenter go mod init datacenter\ngo: creating new go.mod: module datacenter\n\u279c datacenter\n")),(0,i.kt)("p",null,"\u67e5\u770bbook\u76ee\u5f55\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\u279c  datacenter tree\n.\n\u2514\u2500\u2500 go.mod\n\n0 directories, 1 file\n")),(0,i.kt)("h3",{id:"\u521b\u5efaapi\u6587\u4ef6"},"\u521b\u5efaapi\u6587\u4ef6"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\u279c  datacenter goctl api -o datacenter.api\nDone.\n\u279c  datacenter tree\n.\n\u251c\u2500\u2500 datacenter.api\n\u251c\u2500\u2500 user.api  #\u7528\u6237\n\u251c\u2500\u2500 votes.api #\u6295\u7968\n\u251c\u2500\u2500 search.api #\u641c\u7d22\n\u251c\u2500\u2500 questions.api #\u95ee\u7b54\n\u2514\u2500\u2500 go.mod\n")),(0,i.kt)("h3",{id:"\u5b9a\u4e49api\u670d\u52a1"},"\u5b9a\u4e49api\u670d\u52a1"),(0,i.kt)("p",null,"\u5206\u522b\u5305\u542b\u4e86\u4e0a\u9762\u7684 ",(0,i.kt)("strong",{parentName:"p"},"\u516c\u5171\u670d\u52a1"),"\uff0c",(0,i.kt)("strong",{parentName:"p"},"\u7528\u6237\u670d\u52a1"),"\uff0c",(0,i.kt)("strong",{parentName:"p"},"\u6295\u7968\u6d3b\u52a8\u670d\u52a1")),(0,i.kt)("p",null,"datacenter.api\u7684\u5185\u5bb9:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'info(\n    title: "\u4e2d\u53f0\u7cfb\u7edf"// TODO: add title\n    desc: "\u4e2d\u53f0\u7cfb\u7edf"// TODO: add description\n    author: "jackluo"\n    email: "net.webjoy@gmail.com"\n)\n\nimport "user.api"\nimport "votes.api"\nimport "search.api"\nimport "questions.api"\n\n//\u83b7\u53d6 \u5e94\u7528\u4fe1\u606f\ntype Beid {\n    Beid int64 `json:"beid"`\n}\ntype Token {\n    Token string `json:"token"`\n}\ntype WxTicket {\n    Ticket string `json:"ticket"`\n}\ntype Application {\n    Sname       string `json:"Sname"`       //\u540d\u79f0\n    Logo        string `json:"logo"`        // login\n    Isclose     int64  `json:"isclose"`     //\u662f\u5426\u5173\u95ed\n    Fullwebsite string `json:"fullwebsite"` // \u5168\u7ad9\u540d\u79f0\n}\ntype SnsReq {\n    Beid\n    Ptyid   int64  `json:"ptyid"`    //\u5bf9\u5e94\u5e73\u53f0\n    BackUrl string `json:"back_url"` //\u767b\u9646\u8fd4\u56de\u7684\u5730\u5740\n}\ntype SnsResp {\n    Beid\n    Ptyid    int64  `json:"ptyid"`     //\u5bf9\u5e94\u5e73\u53f0\n    Appid    string `json:"appid"`     //sns \u5e73\u53f0\u7684id\n    Title    string `json:"title"`     //\u540d\u79f0\n    LoginUrl string `json:"login_url"` //\u5fae\u4fe1\u767b\u9646\u7684\u5730\u5740\n}\n\ntype WxShareResp {\n    Appid     string `json:"appid"`\n    Timestamp int64  `json:"timestamp"`\n    Noncestr  string `json:"noncestr"`\n    Signature string `json:"signature"`\n}\n\n@server(\n    group: common\n)\nservice datacenter-api {\n    @doc(\n        summary: "\u83b7\u53d6\u7ad9\u70b9\u7684\u4fe1\u606f"\n    )\n    @handler appInfo\n    get /common/appinfo (Beid) returns (Application)\n    @doc(\n        summary: "\u83b7\u53d6\u7ad9\u70b9\u7684\u793e\u4ea4\u5c5e\u6027\u4fe1\u606f"\n    )\n    @handler snsInfo\n    post /common/snsinfo (SnsReq) returns (SnsResp)\n    \n    //\u83b7\u53d6\u5206\u4eab\u7684\n    @handler wxTicket\n    post /common/wx/ticket (SnsReq) returns (WxShareResp)\n    \n}\n\n//\u4e0a\u4f20\u9700\u8981\u767b\u9646\n@server(\n    jwt: Auth\n    group: common\n)\nservice datacenter-api {\n    @doc(\n        summary: "\u4e03\u725b\u4e0a\u4f20\u51ed\u8bc1"\n    )\n    @handler qiuniuToken\n    post /common/qiuniu/token (Beid) returns (Token)\n}\n')),(0,i.kt)("p",null,"user.api\u5185\u5bb9"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'//\u6ce8\u518c\u8bf7\u6c42\ntype RegisterReq struct {\n    // TODO: add members here and delete this comment\n    Mobile   string `json:"mobile"` //\u57fa\u672c\u4e00\u4e2a\u624b\u673a\u53f7\u7801\u5c31\u5b8c\u4e8b\n    Password string `json:"password"`\n    Smscode string `json:"smscode"` //\u77ed\u4fe1\u7801\n}\n//\u767b\u9646\u8bf7\u6c42\ntype LoginReq struct{\n    Mobile   string `json:"mobile"`\n    Type int64 `json:"type"`    //1.\u5bc6\u7801\u767b\u9646\uff0c2.\u77ed\u4fe1\u767b\u9646\n    Password string `json:"password"`\n}\n//\u5fae\u4fe1\u767b\u9646\ntype WxLoginReq struct {\n    Beid      int64  `json:"beid"` //\u5e94\u7528id\n    Code string `json:"code"` //\u5fae\u4fe1\u767b\u9646\u5bc6\u94a5\n    Ptyid     int64  `json:"ptyid"` //\u5bf9\u5e94\u5e73\u53f0\n}\n\n//\u8fd4\u56de\u7528\u6237\u4fe1\u606f\ntype UserReply struct {\n    Auid       int64  `json:"auid"`\n    Uid       int64  `json:"uid"`\n    Beid      int64  `json:"beid"` //\u5e94\u7528id\n    Ptyid     int64  `json:"ptyid"` //\u5bf9\u5e94\u5e73\u53f0\n    Username string `json:"username"`\n    Mobile   string `json:"mobile"`\n    Nickname string `json:"nickname"`\n    Openid string `json:"openid"`\n    Avator string `json:"avator"`\n    JwtToken\n}\n//\u8fd4\u56deAPPUser\ntype AppUser struct{\n    Uid       int64  `json:"uid"`\n    Auid       int64  `json:"auid"`\n    Beid      int64  `json:"beid"` //\u5e94\u7528id\n    Ptyid     int64  `json:"ptyid"` //\u5bf9\u5e94\u5e73\u53f0\n    Nickname string `json:"nickname"`\n    Openid string `json:"openid"`\n    Avator string `json:"avator"`\n}\n\ntype LoginAppUser struct{\n    Uid       int64  `json:"uid"`\n    Auid       int64  `json:"auid"`\n    Beid      int64  `json:"beid"` //\u5e94\u7528id\n    Ptyid     int64  `json:"ptyid"` //\u5bf9\u5e94\u5e73\u53f0\n    Nickname string `json:"nickname"`\n    Openid string `json:"openid"`\n    Avator string `json:"avator"`\n    JwtToken\n}\n\ntype JwtToken struct {\n    AccessToken  string `json:"access_token,omitempty"`\n    AccessExpire int64  `json:"access_expire,omitempty"`\n    RefreshAfter int64  `json:"refresh_after,omitempty"`\n}\n\ntype UserReq struct{\n    Auid       int64  `json:"auid"`\n    Uid       int64  `json:"uid"`\n    Beid      int64  `json:"beid"` //\u5e94\u7528id\n    Ptyid     int64  `json:"ptyid"` //\u5bf9\u5e94\u5e73\u53f0\n}\n\ntype Request {\n    Name string `path:"name,options=you|me"`\n}\ntype Response {\n    Message string `json:"message"`\n}\n\n\n@server(\n    group: user\n)\nservice datacenter-api {\n    @handler ping\n    post /user/ping ()\n    \n    @handler register\n    post /user/register (RegisterReq) returns (UserReply)\n    \n    @handler login\n    post /user/login (LoginReq) returns (UserReply)\n    \n    @handler wxlogin\n    post /user/wx/login (WxLoginReq) returns (LoginAppUser)\n    \n    @handler code2Session\n    get /user/wx/login () returns (LoginAppUser)\n}\n@server(\n    jwt: Auth\n    group: user\n    middleware: Usercheck\n)\nservice datacenter-api {\n    @handler userInfo\n    get /user/dc/info (UserReq) returns (UserReply)\n}\n')),(0,i.kt)("p",null,"votes.api \u6295\u7968\u5185\u5bb9"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'// \u6295\u7968\u6d3b\u52a8api\n\n\ntype Actid struct {\n    Actid       int64  `json:"actid"` //\u6d3b\u52a8id\n}\n\ntype VoteReq struct {\n    Aeid       int64  `json:"aeid"` // \u4f5c\u54c1id\n    Actid\n}\ntype VoteResp struct {\n    VoteReq\n    Votecount       int64  `json:"votecount"` //\u6295\u7968\u7968\u6570\n    Viewcount       int64  `json:"viewcount"` //\u6d4f\u89c8\u6570\n}\n\n\n// \u6d3b\u52a8\u8fd4\u56de\u7684\u53c2\u6570\n\ntype ActivityResp struct {\n    Actid           int64  `json:"actid"`\n    Title           string  `json:"title"` //\u6d3b\u52a8\u540d\u79f0\n    Descr           string  `json:"descr"` //\u6d3b\u52a8\u63cf\u8ff0\n    StartDate       int64  `json:"start_date"` //\u6d3b\u52a8\u65f6\u95f4\n    EnrollDate      int64  `json:"enroll_date"` //\u6295\u7968\u65f6\u95f4\n    EndDate         int64  `json:"end_date"` //\u6d3b\u52a8\u7ed3\u675f\u65f6\u95f4\n    Votecount       int64  `json:"votecount"` //\u5f53\u524d\u6d3b\u52a8\u7684\u603b\u7968\u6570\n    Viewcount       int64  `json:"viewcount"` //\u5f53\u524d\u6d3b\u52a8\u7684\u603b\u6d4f\u89c8\u6570\n    Type            int64 `json:"type"` //\u6295\u7968\u65b9\u5f0f\n    Num             int64 `json:"num"` //\u6295\u7968\u51e0\u7968\n}\n//\u62a5\u540d\n\n\ntype EnrollReq struct {\n    Actid\n    Name        string  `json:"name"` // \u540d\u79f0\n    Address         string  `json:"address"` //\u5730\u5740\n    Images          []string  `json:"images"` //\u4f5c\u54c1\u56fe\u7247\n    Descr           string  `json:"descr"` // \u4f5c\u54c1\u63cf\u8ff0\n}\n// \u4f5c\u54c1\u8fd4\u56de\n\ntype EnrollResp struct {\n    Actid\n    Aeid        int64 `json:"aeid"` // \u4f5c\u54c1id\n    Name        string  `json:"name"` // \u540d\u79f0\n    Address         string  `json:"address"` //\u5730\u5740\n    Images          []string  `json:"images"` //\u4f5c\u54c1\u56fe\u7247\n    Descr           string  `json:"descr"` // \u4f5c\u54c1\u63cf\u8ff0\n    Votecount       int64  `json:"votecount"` //\u5f53\u524d\u6d3b\u52a8\u7684\u603b\u7968\u6570\n    Viewcount       int64  `json:"viewcount"` //\u5f53\u524d\u6d3b\u52a8\u7684\u603b\u6d4f\u89c8\u6570\n    \n}\n\n\n@server(\n    group: votes\n)\nservice datacenter-api {\n    @doc(\n        summary: "\u83b7\u53d6\u6d3b\u52a8\u7684\u4fe1\u606f"\n    )\n    @handler activityInfo\n    get /votes/activity/info (Actid) returns (ActivityResp)\n    @doc(\n        summary: "\u6d3b\u52a8\u8bbf\u95ee+1"\n    )\n    @handler activityIcrView\n    get /votes/activity/view (Actid) returns (ActivityResp)\n    @doc(\n        summary: "\u83b7\u53d6\u62a5\u540d\u7684\u6295\u7968\u4f5c\u54c1\u4fe1\u606f"\n    )\n    @handler enrollInfo\n    get /votes/enroll/info (VoteReq) returns (EnrollResp)\n    @doc(\n        summary: "\u83b7\u53d6\u62a5\u540d\u7684\u6295\u7968\u4f5c\u54c1\u5217\u8868"\n    )\n    @handler enrollLists\n    get /votes/enroll/lists (Actid) returns(EnrollResp)\n}\n\n@server(\n    jwt: Auth\n    group: votes\n    middleware: Usercheck\n)\nservice datacenter-api {\n    @doc(\n        summary: "\u6295\u7968"\n    )\n    @handler vote\n    post /votes/vote (VoteReq) returns (VoteResp)\n    @handler enroll\n    post /votes/enroll (EnrollReq) returns (EnrollResp)\n}\n\n')),(0,i.kt)("p",null,"questions.api \u95ee\u7b54\u5185\u5bb9:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'// \u95ee\u7b54 \u62bd\u5956 \u5f00\u59cb\n@server(\n    group: questions\n)\nservice datacenter-api {\n    @doc(\n        summary: "\u83b7\u53d6\u6d3b\u52a8\u7684\u4fe1\u606f"\n    )\n    @handler activitiesInfo\n    get /questions/activities/info (Actid) returns (ActivityResp)\n    @doc(\n        summary: "\u83b7\u53d6\u5956\u54c1\u4fe1\u606f"\n    )\n    @handler awardInfo\n    get /questions/award/info (Actid) returns (ActivityResp)\n\n    @handler awardList\n    get /questions/award/list (Actid) returns (ActivityResp)\n    \n}\ntype AnswerReq struct {\n    ActivityId  int64 `json:"actid"` \n    Answers string `json:"answers"` \n    Score   string `json:"score"`\n}\ntype QuestionsAwardReq struct {\n    ActivityId  int64 `json:"actid"` \n    AnswerId    int64 `json:"answerid"` \n}\ntype AnswerResp struct {\n    Answers string `json:"answers"` \n    Score   string `json:"score"`\n}\ntype AwardConvertReq struct {\n    UserName    string `json:"username"` \n    Phone       string `json:"phone"` \n    LotteryId   int64 `json:"lotteryid"` \n}\n\n\n@server(\n    jwt: Auth\n    group: questions\n    middleware: Usercheck\n)\nservice datacenter-api {\n    @doc(\n        summary: "\u83b7\u53d6\u9898\u76ee"\n    )\n    @handler lists\n    get /questions/lists (VoteReq) returns (AnswerResp)\n    @doc(\n        summary: "\u63d0\u4ea4\u7b54\u6848"\n    )\n    @handler change\n    post /questions/change (AnswerReq) returns (VoteResp)\n\n    @doc(\n        summary: "\u83b7\u53d6\u5206\u6570"\n    )\n    @handler grade\n    get /questions/grade (VoteReq) returns (VoteResp)\n\n    @doc(\n        summary: "\u5f00\u59cb\u8f6c\u76d8"\n    )\n    @handler turntable\n    post /questions/lottery/turntable (EnrollReq) returns (EnrollResp)\n    @doc(\n        summary: "\u586b\u5199\u4e2d\u5956\u4fe1\u606f\u4eba"\n    )\n    @handler lottery\n    post /questions/lottery/convert (AwardConvertReq) returns (EnrollResp)\n}\n\n\n// \u95ee\u7b54 \u62bd\u5956 \u7ed3\u675f\n')),(0,i.kt)("p",null,"search.api \u641c\u7d22"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'\n\ntype SearchReq struct {\n    Keyword string `json:"keyword"`\n    Page string `json:"page"`\n    Size string `json:"size"`\n}\ntype SearchResp struct {\n    Data []ArticleReq `json:"data"`\n}\n\ntype ArticleReq struct{\n    NewsId string `json:"NewsId"`\n    NewsTitle string `json:"NewsTitle"`\n    ImageUrl string `json:"ImageUrl"`\n}\n\n\n@server(\n    group: search\n    middleware: Admincheck\n)\nservice datacenter-api {\n    @doc(\n        summary: "\u641c\u7d22"\n    )\n    @handler article\n    get /search/article (SearchReq) returns (SearchResp)\n    @handler articleInit\n    get /search/articel/init (SearchReq) returns (SearchResp)\n    @handler articleStore\n    post /search/articel/store (ArticleReq) returns (ArticleReq)\n}\n\n')),(0,i.kt)("p",null,"\u4e0a\u9762\u57fa\u672c\u4e0a\u5199\u5c31\u5199\u7684API\u53ca\u6587\u6863\u7684\u601d\u8def"),(0,i.kt)("h3",{id:"\u751f\u6210datacenter-api\u670d\u52a1"},"\u751f\u6210datacenter api\u670d\u52a1"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\u279c  datacenter goctl api go -api datacenter.api -dir .\nDone.\n\u279c  datacenter treer\n.\n\u251c\u2500\u2500 datacenter.api\n\u251c\u2500\u2500 etc\n\u2502   \u2514\u2500\u2500 datacenter-api.yaml\n\u251c\u2500\u2500 go.mod\n\u251c\u2500\u2500 internal\n\u2502   \u251c\u2500\u2500 config\n\u2502   \u2502   \u2514\u2500\u2500 config.go\n\u2502   \u251c\u2500\u2500 handler\n\u2502   \u2502   \u251c\u2500\u2500 common\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 appinfohandler.go\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 qiuniutokenhandler.go\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 snsinfohandler.go\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 votesverificationhandler.go\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 wxtickethandler.go\n\u2502   \u2502   \u251c\u2500\u2500 routes.go\n\u2502   \u2502   \u251c\u2500\u2500 user\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 code2sessionhandler.go\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 loginhandler.go\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 pinghandler.go\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 registerhandler.go\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 userinfohandler.go\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 wxloginhandler.go\n\u2502   \u2502   \u2514\u2500\u2500 votes\n\u2502   \u2502       \u251c\u2500\u2500 activityicrviewhandler.go\n\u2502   \u2502       \u251c\u2500\u2500 activityinfohandler.go\n\u2502   \u2502       \u251c\u2500\u2500 enrollhandler.go\n\u2502   \u2502       \u251c\u2500\u2500 enrollinfohandler.go\n\u2502   \u2502       \u251c\u2500\u2500 enrolllistshandler.go\n\u2502   \u2502       \u2514\u2500\u2500 votehandler.go\n\u2502   \u251c\u2500\u2500 logic\n\u2502   \u2502   \u251c\u2500\u2500 common\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 appinfologic.go\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 qiuniutokenlogic.go\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 snsinfologic.go\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 votesverificationlogic.go\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 wxticketlogic.go\n\u2502   \u2502   \u251c\u2500\u2500 user\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 code2sessionlogic.go\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 loginlogic.go\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 pinglogic.go\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 registerlogic.go\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 userinfologic.go\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 wxloginlogic.go\n\u2502   \u2502   \u2514\u2500\u2500 votes\n\u2502   \u2502       \u251c\u2500\u2500 activityicrviewlogic.go\n\u2502   \u2502       \u251c\u2500\u2500 activityinfologic.go\n\u2502   \u2502       \u251c\u2500\u2500 enrollinfologic.go\n\u2502   \u2502       \u251c\u2500\u2500 enrolllistslogic.go\n\u2502   \u2502       \u251c\u2500\u2500 enrolllogic.go\n\u2502   \u2502       \u2514\u2500\u2500 votelogic.go\n\u2502   \u251c\u2500\u2500 middleware\n\u2502   \u2502   \u2514\u2500\u2500 usercheckmiddleware.go\n\u2502   \u251c\u2500\u2500 svc\n\u2502   \u2502   \u2514\u2500\u2500 servicecontext.go\n\u2502   \u2514\u2500\u2500 types\n\u2502       \u2514\u2500\u2500 types.go\n\u2514\u2500\u2500 datacenter.go\n\n14 directories, 43 files\n")),(0,i.kt)("p",null,"\u6211\u4eec\u6253\u5f00 ",(0,i.kt)("inlineCode",{parentName:"p"},"etc/datacenter-api.yaml")," \u628a\u5fc5\u8981\u7684\u914d\u7f6e\u4fe1\u606f\u52a0\u4e0a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"Name: datacenter-api\nLog:\n  Mode: console\nHost: 0.0.0.0\nPort: 8857\nAuth:\n  AccessSecret: \u4f60\u7684jwtwon Secret\n  AccessExpire: 86400\nCacheRedis:\n- Host: 127.0.0.1:6379\n  Pass: \u5bc6\u7801\n  Type: node                     \nUserRpc:\n  Etcd:\n    Hosts:\n      - 127.0.0.1:2379\n    Key: user.rpc\nCommonRpc:\n  Etcd:\n    Hosts:\n      - 127.0.0.1:2379\n    Key: common.rpc\nVotesRpc:\n  Etcd:\n    Hosts:\n      - 127.0.0.1:2379\n    Key: votes.rpc\n")),(0,i.kt)("p",null,"\u4e0a\u9762\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"UserRpc"),"\uff0c ",(0,i.kt)("inlineCode",{parentName:"p"},"CommonRpc")," ,\u8fd8\u6709 ",(0,i.kt)("inlineCode",{parentName:"p"},"VotesRpc")," \u8fd9\u4e9b\u6211\u5148\u5199\u4e0a\uff0c\u540e\u9762\u518d\u6765\u6162\u6162\u52a0\u3002"),(0,i.kt)("p",null,"\u6211\u4eec\u5148\u6765\u5199 ",(0,i.kt)("inlineCode",{parentName:"p"},"CommonRpc")," \u670d\u52a1\u3002"),(0,i.kt)("h2",{id:"commonrpc\u670d\u52a1"},"CommonRpc\u670d\u52a1"),(0,i.kt)("h3",{id:"\u65b0\u5efa\u9879\u76ee\u76ee\u5f55"},"\u65b0\u5efa\u9879\u76ee\u76ee\u5f55"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\u279c  datacenter mkdir -p common/rpc && cd common/rpc\n")),(0,i.kt)("p",null,"\u76f4\u63a5\u5c31\u65b0\u5efa\u5728\u4e86\uff0cdatacenter\u76ee\u5f55\u4e2d\uff0c\u56e0\u4e3acommon \u91cc\u9762\uff0c\u53ef\u80fd\u4ee5\u540e\u4f1a\u4e0d\u53ea\u4f1a\u63d0\u4f9brpc\u670d\u52a1\uff0c\u53ef\u80fd\u8fd8\u6709api\u7684\u670d\u52a1,\u6240\u4ee5\u53c8\u52a0\u4e86rpc\u76ee\u5f55"),(0,i.kt)("h3",{id:"goctl\u521b\u5efa\u6a21\u677f"},"goctl\u521b\u5efa\u6a21\u677f"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\u279c  rpc goctl rpc template -o=common.proto\n\u279c  rpc ls\ncommon.proto\n")),(0,i.kt)("p",null,"\u5f80\u91cc\u9762\u586b\u5165\u5185\u5bb9\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-protobufbuf"},'\u279c  rpc cat common.proto\nsyntax = "proto3";\n\noption go_package = "common";\n\npackage common;\n\n\nmessage BaseAppReq{\n  int64 beid=1;\n}\n\nmessage BaseAppResp{\n  int64 beid=1;\n  string logo=2;\n  string sname=3;\n  int64 isclose=4;\n  string fullwebsite=5;\n}\n\n// \u8bf7\u6c42\u7684api\nmessage AppConfigReq {\n  int64 beid=1;\n  int64 ptyid=2;\n}\n\n// \u8fd4\u56de\u7684\u503c\nmessage AppConfigResp {\n  int64 id=1;\n  int64 beid=2;\n  int64 ptyid=3;\n  string appid=4;\n  string appsecret=5;\n  string title=6;\n}\n\nservice Common {\n  rpc GetAppConfig(AppConfigReq) returns(AppConfigResp);\n  rpc GetBaseApp(BaseAppReq) returns(BaseAppResp);\n}\n')),(0,i.kt)("h3",{id:"gotcl\u751f\u6210rpc\u670d\u52a1"},"gotcl\u751f\u6210rpc\u670d\u52a1"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"\u279c  rpc goctl rpc proto -src common.proto -dir .\nprotoc  -I=/Users/jackluo/works/blogs/datacenter/common/rpc common.proto --go_out=plugins=grpc:/Users/jackluo/works/blogs/datacenter/common/rpc/common\nDone.\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\u279c rpc tree\n.\n\u251c\u2500\u2500 common\n\u2502  \u2514\u2500\u2500 common.pb.go\n\u251c\u2500\u2500 common.go\n\u251c\u2500\u2500 common.proto\n\u251c\u2500\u2500 commonclient\n\u2502  \u2514\u2500\u2500 common.go\n\u251c\u2500\u2500 etc\n\u2502  \u2514\u2500\u2500 common.yaml\n\u2514\u2500\u2500 internal\n\u251c\u2500\u2500 config\n\u2502  \u2514\u2500\u2500 config.go\n\u251c\u2500\u2500 logic\n\u2502  \u251c\u2500\u2500 getappconfiglogic.go\n\u2502  \u2514\u2500\u2500 getbaseapplogic.go\n\u251c\u2500\u2500 server\n\u2502  \u2514\u2500\u2500 commonserver.go\n\u2514\u2500\u2500 svc\n\u2514\u2500\u2500 servicecontext.go\n\n8 directories, 10 files\n")),(0,i.kt)("p",null,"\u57fa\u672c\u4e0a\uff0c\u5c31\u628a\u6240\u6709\u7684\u76ee\u5f55\u89c4\u8303\u548c\u7ed3\u6784\u7684\u4e1c\u897f\u90fd\u751f\u6210\u4e86\uff0c\u5c31\u4e0d\u7528\u7ea0\u7ed3\u9879\u76ee\u76ee\u5f55\u4e86\uff0c\u600e\u4e48\u653e\u4e86\uff0c\u600e\u4e48\u7ec4\u7ec7\u4e86\u3002"),(0,i.kt)("p",null,"\u770b\u4e00\u4e0b\uff0c\u914d\u7f6e\u4fe1\u606f\uff0c\u91cc\u9762\u53ef\u4ee5\u5199\u5165mysql\u548c\u5176\u5b83redis\u7684\u4fe1\u606f\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"Name: common.rpc\nListenOn: 127.0.0.1:8081\nMysql:\n  DataSource: root:admin@tcp(127.0.0.1:3306)/datacenter?charset=utf8&parseTime=true&loc=Asia%2FShanghai\nCacheRedis:\n- Host: 127.0.0.1:6379\n  Pass:\n  Type: node  \nEtcd:\n  Hosts:\n  - 127.0.0.1:2379\n  Key: common.rpc\n")),(0,i.kt)("p",null,"\u6211\u4eec\u518d\u6765\u52a0\u4e0a\u6570\u636e\u5e93\u670d\u52a1\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'\u279c  rpc cd ..\n\u279c  common ls\nrpc\n\u279c  common pwd\n/Users/jackluo/works/blogs/datacenter/common\n\u279c  common goctl model mysql datasource -url="root:admin@tcp(127.0.0.1:3306)/datacenter" -table="base_app" -dir ./model -c\nDone.\n\u279c  common tree\n.\n\u251c\u2500\u2500 model\n\u2502   \u251c\u2500\u2500 baseappmodel.go\n\u2502   \u2514\u2500\u2500 vars.go\n\u2514\u2500\u2500 rpc\n    \u251c\u2500\u2500 common\n    \u2502   \u2514\u2500\u2500 common.pb.go\n    \u251c\u2500\u2500 common.go\n    \u251c\u2500\u2500 common.proto\n    \u251c\u2500\u2500 commonclient\n    \u2502   \u2514\u2500\u2500 common.go\n    \u251c\u2500\u2500 etc\n    \u2502   \u2514\u2500\u2500 common.yaml\n    \u2514\u2500\u2500 internal\n        \u251c\u2500\u2500 config\n        \u2502   \u2514\u2500\u2500 config.go\n        \u251c\u2500\u2500 logic\n        \u2502   \u251c\u2500\u2500 getappconfiglogic.go\n        \u2502   \u2514\u2500\u2500 getbaseapplogic.go\n        \u251c\u2500\u2500 server\n        \u2502   \u2514\u2500\u2500 commonserver.go\n        \u2514\u2500\u2500 svc\n            \u2514\u2500\u2500 servicecontext.go\n\n10 directories, 12 files\n')),(0,i.kt)("p",null,"\u8fd9\u6837\u57fa\u672c\u7684\u4e00\u4e2a ",(0,i.kt)("inlineCode",{parentName:"p"},"rpc")," \u5c31\u5199\u5b8c\u4e86\uff0c\u7136\u540e\u6211\u4eec\u5c06rpc \u548cmodel \u8fd8\u6709api\u4e32\u8fde\u8d77\u6765\uff0c\u8fd9\u4e2a\u5b98\u65b9\u7684\u6587\u6863\u5df2\u7ecf\u5f88\u8be6\u7ec6\u4e86\uff0c\u8fd9\u91cc\u5c31\u53ea\u662f\u8d34\u4e00\u4e0b\u4ee3\u7801\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'\u279c  common cat rpc/internal/config/config.go\npackage config\n\nimport (\n    "github.com/zeromicro/go-zero/core/stores/cache"\n    "github.com/zeromicro/go-zero/zrpc"\n)\n\ntype Config struct {\n    zrpc.RpcServerConf\n    Mysql struct {\n        DataSource string\n    }\n    CacheRedis cache.ClusterConf\n}\n')),(0,i.kt)("p",null,"\u518d\u5728svc\u4e2d\u4fee\u6539\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'\u279c  common cat rpc/internal/svc/servicecontext.go\npackage svc\n\nimport (\n    "datacenter/common/model"\n    "datacenter/common/rpc/internal/config"\n\n    "github.com/zeromicro/go-zero/core/stores/sqlx"\n)\n\ntype ServiceContext struct {\n    c              config.Config\n    AppConfigModel model.AppConfigModel\n    BaseAppModel   model.BaseAppModel\n}\n\nfunc NewServiceContext(c config.Config) *ServiceContext {\n    conn := sqlx.NewMysql(c.Mysql.DataSource)\n    apm := model.NewAppConfigModel(conn, c.CacheRedis)\n    bam := model.NewBaseAppModel(conn, c.CacheRedis)\n    return &ServiceContext{\n        c:              c,\n        AppConfigModel: apm,\n        BaseAppModel:   bam,\n    }\n}\n')),(0,i.kt)("p",null,"\u4e0a\u9762\u7684\u4ee3\u7801\u5df2\u7ecf\u5c06 ",(0,i.kt)("inlineCode",{parentName:"p"},"rpc")," \u548c ",(0,i.kt)("inlineCode",{parentName:"p"},"model")," \u6570\u636e\u5e93\u5173\u8054\u8d77\u6765\u4e86\uff0c\u6211\u4eec\u73b0\u5728\u518d\u5c06 ",(0,i.kt)("inlineCode",{parentName:"p"},"rpc")," \u548c ",(0,i.kt)("inlineCode",{parentName:"p"},"api")," \u5173\u8054\u8d77\u6765\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'\u279c  datacenter cat internal/config/config.go\n\npackage config\n\nimport (\n    "github.com/zeromicro/go-zero/core/stores/cache"\n    "github.com/zeromicro/go-zero/rest"\n    "github.com/zeromicro/go-zero/zrpc"\n)\n\ntype Config struct {\n    rest.RestConf\n\n    Auth struct {\n        AccessSecret string\n        AccessExpire int64\n    }\n    UserRpc   zrpc.RpcClientConf\n    CommonRpc zrpc.RpcClientConf\n    VotesRpc  zrpc.RpcClientConf\n\n    CacheRedis cache.ClusterConf\n}\n')),(0,i.kt)("p",null,"\u52a0\u5165 ",(0,i.kt)("inlineCode",{parentName:"p"},"svc")," \u670d\u52a1\u4e2d\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'\u279c  datacenter cat internal/svc/servicecontext.go\npackage svc\n\nimport (\n    "context"\n    "datacenter/common/rpc/commonclient"\n    "datacenter/internal/config"\n    "datacenter/internal/middleware"\n    "datacenter/shared"\n    "datacenter/user/rpc/userclient"\n    "datacenter/votes/rpc/votesclient"\n    "fmt"\n    "net/http"\n    "time"\n\n    "github.com/zeromicro/go-zero/core/logx"\n    "github.com/zeromicro/go-zero/core/stores/cache"\n    "github.com/zeromicro/go-zero/core/stores/redis"\n    "github.com/zeromicro/go-zero/core/syncx"\n    "github.com/zeromicro/go-zero/rest"\n    "github.com/zeromicro/go-zero/zrpc"\n    "google.golang.org/grpc"\n)\n\ntype ServiceContext struct {\n    Config           config.Config\n    GreetMiddleware1 rest.Middleware\n    GreetMiddleware2 rest.Middleware\n    Usercheck        rest.Middleware\n    UserRpc          userclient.User //\u7528\u6237\n    CommonRpc        commonclient.Common\n    VotesRpc         votesclient.Votes\n    Cache            cache.Cache\n    RedisConn        *redis.Redis\n}\n\nfunc timeInterceptor(ctx context.Context, method string, req, reply interface{}, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption) error {\n    stime := time.Now()\n    err := invoker(ctx, method, req, reply, cc, opts...)\n    if err != nil {\n        return err\n    }\n\n    fmt.Printf("\u8c03\u7528 %s \u65b9\u6cd5 \u8017\u65f6: %v\\n", method, time.Now().Sub(stime))\n    return nil\n}\nfunc NewServiceContext(c config.Config) *ServiceContext {\n\n    ur := userclient.NewUser(zrpc.MustNewClient(c.UserRpc, zrpc.WithUnaryClientInterceptor(timeInterceptor)))\n    cr := commonclient.NewCommon(zrpc.MustNewClient(c.CommonRpc, zrpc.WithUnaryClientInterceptor(timeInterceptor)))\n    vr := votesclient.NewVotes(zrpc.MustNewClient(c.VotesRpc, zrpc.WithUnaryClientInterceptor(timeInterceptor)))\n    //\u7f13\u5b58\n    ca := cache.NewCache(c.CacheRedis, syncx.NewSharedCalls(), cache.NewCacheStat("dc"), shared.ErrNotFound)\n    rcon := redis.NewRedis(c.CacheRedis[0].Host, c.CacheRedis[0].Type, c.CacheRedis[0].Pass)\n    return &ServiceContext{\n        Config:           c,\n        GreetMiddleware1: greetMiddleware1,\n        GreetMiddleware2: greetMiddleware2,\n        Usercheck:        middleware.NewUserCheckMiddleware().Handle,\n        UserRpc:          ur,\n        CommonRpc:        cr,\n        VotesRpc:         vr,\n        Cache:            ca,\n        RedisConn:        rcon,\n    }\n}\n')),(0,i.kt)("p",null,"\u8fd9\u6837\u57fa\u672c\u4e0a\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 ",(0,i.kt)("inlineCode",{parentName:"p"},"logic")," \u7684\u6587\u4ef6\u76ee\u5f55\u4e2d\u8c03\u7528\u4e86\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'cat internal/logic/common/appinfologic.go\n\npackage logic\n\nimport (\n    "context"\n\n    "datacenter/internal/svc"\n    "datacenter/internal/types"\n    "datacenter/shared"\n\n    "datacenter/common/model"\n    "datacenter/common/rpc/common"\n\n    "github.com/zeromicro/go-zero/core/logx"\n)\n\ntype AppInfoLogic struct {\n    logx.Logger\n    ctx    context.Context\n    svcCtx *svc.ServiceContext\n}\n\nfunc NewAppInfoLogic(ctx context.Context, svcCtx *svc.ServiceContext) AppInfoLogic {\n    return AppInfoLogic{\n        Logger: logx.WithContext(ctx),\n        ctx:    ctx,\n        svcCtx: svcCtx,\n    }\n}\n\nfunc (l *AppInfoLogic) AppInfo(req types.Beid) (appconfig *common.BaseAppResp, err error) {\n\n    //\u68c0\u67e5 \u7f13\u5b58\u4e2d\u662f\u5426\u6709\u503c\n    err = l.svcCtx.Cache.GetCache(model.GetcacheBaseAppIdPrefix(req.Beid), appconfig)\n    if err != nil && err == shared.ErrNotFound {\n        appconfig, err = l.svcCtx.CommonRpc.GetBaseApp(l.ctx, &common.BaseAppReq{\n            Beid: req.Beid,\n        })\n        if err != nil {\n            return\n        }\n        err = l.svcCtx.Cache.SetCache(model.GetcacheBaseAppIdPrefix(req.Beid), appconfig)\n    }\n\n    return\n}\n')),(0,i.kt)("p",null,"\u8fd9\u6837\uff0c\u57fa\u672c\u5c31\u8fde\u63a5\u8d77\u6765\u4e86\uff0c\u5176\u5b83\u57fa\u672c\u4e0a\u5c31\u4e0d\u7528\u6539\u4e86\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},"UserRPC"),"\uff0c ",(0,i.kt)("inlineCode",{parentName:"p"},"VotesRPC")," \u7c7b\u4f3c\uff0c\u8fd9\u91cc\u5c31\u4e0d\u5728\u5199\u4e86\u3002"),(0,i.kt)("h2",{id:"\u4f7f\u7528\u5fc3\u5f97"},"\u4f7f\u7528\u5fc3\u5f97"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"go-zero")," \u7684\u786e\u9999\uff0c\u56e0\u4e3a\u5b83\u6709\u4e00\u4e2a ",(0,i.kt)("inlineCode",{parentName:"p"},"goctl")," \u7684\u5de5\u5177\uff0c\u4ed6\u53ef\u4ee5\u81ea\u52a8\u7684\u628a\u4ee3\u7801\u7ed3\u6784\u5168\u90e8\u7684\u751f\u6210\u597d\uff0c\u6211\u4eec\u5c31\u4e0d\u518d\u53bb\u7ea0\u7ed3\uff0c\u76ee\u5f55\u7ed3\u6784 \uff0c\u600e\u4e48\u7ec4\u7ec7\uff0c\u6ca1\u6709\u4e2a\u597d\u51e0\u5e74\u7684\u67b6\u6784\u80fd\u529b\u662f\u4e0d\u597d\u5b9e\u73b0\u7684\uff0c\u6709\u4ec0\u4e48\u89c4\u8303\u90a3\u4e9b\uff0c\u5e76\u53d1\uff0c\u7194\u65ad\uff0c\u5b8c\u5168\u4e0d\u7528\uff0c\u8003\u6ee4\u5176\u5b83\u7684\uff0c\u4e13\u5fc3\u7684\u5b9e\u73b0\u4e1a\u52a1\u5c31\u597d\uff0c\u50cf\u5fae\u670d\u52a1\uff0c\u8fd8\u8981\u6709\u670d\u52a1\u53d1\u73b0\uff0c\u4e00\u7cfb\u5217\u7684\u4e1c\u897f\uff0c\u90fd\u4e0d\u7528\u5173\u5fc3\uff0c\u56e0\u4e3a ",(0,i.kt)("inlineCode",{parentName:"p"},"go-zero")," \u5185\u90e8\u5df2\u7ecf\u5b9e\u73b0\u4e86\u3002"),(0,i.kt)("p",null,"\u6211\u5199\u4ee3\u7801\u4e5f\u5199\u4e86\u670910\u591a\u5e74\u4e86\uff0c\u4e4b\u524d\u4e00\u76f4\u7528\u7684 php\uff0c\u6bd4\u8f83\u51fa\u540d\u7684\u5c31 laravel\uff0cthinkphp\uff0c\u57fa\u672c\u4e0a\u5c31\u662f\u6a21\u5757\u5316\u7684,\u50cf\u5fae\u670d\u90a3\u4e9b\u5b9e\u73b0\u76f4\u6765\u771f\u7684\u6709\u6210\u672c\uff0c\u4f46\u662f\u4f60\u7528\u4e0ago-zero\uff0c\u4f60\u5c31\u50cf\u8c03api\u63a5\u53e3\u4e00\u6837\u7b80\u5355\u7684\u5f00\u53d1\uff0c\u5176\u5b83\u4ec0\u4e48\u670d\u52a1\u53d1\u73b0\uff0c\u90a3\u4e9b\u6839\u672c\u5c31\u4e0d\u7528\u5173\u6ce8\u4e86\uff0c\u53ea\u9700\u8981\u5173\u6ce8\u4e1a\u52a1\u3002"),(0,i.kt)("p",null,"\u4e00\u4e2a\u597d\u7684\u8bed\u8a00\uff0c\u6846\u67b6\uff0c\u4ed6\u4eec\u7684\u5e95\u5c42\u601d\u7ef4\uff0c\u6c38\u8fdc\u90fd\u662f\u6548\u7387\u9ad8\uff0c\u4e0d\u52a0\u73ed\u7684\u601d\u60f3\uff0c\u6211\u76f8\u4fe1go-zero\u4f1a\u63d0\u9ad8\u4f60\u548c\u4f60\u56e2\u961f\u6216\u662f\u516c\u53f8\u7684\u6548\u7387\u3002go-zero\u7684\u4f5c\u8005\u8bf4\uff0c\u4ed6\u4eec\u6709\u4e2a\u56e2\u961f\u4e13\u95e8\u6574\u7406go-zero\u6846\u67b6\uff0c\u76ee\u7684\u4e5f\u5e94\u8be5\u5f88\u660e\u663e\uff0c\u90a3\u5c31\u662f\u63d0\u9ad8\uff0c\u4ed6\u4eec\u81ea\u5df1\u7684\u5f00\u53d1\u6548\u7387\uff0c\u6d41\u7a0b\u5316\uff0c\u6807\u51c6\u5316\uff0c\u662f\u63d0\u9ad8\u5de5\u4f5c\u6548\u7387\u7684\u51c6\u5219\uff0c\u50cf\u6211\u4eec\u5e73\u65f6\u9047\u5230\u4e86\u95ee\u9898\uff0c\u6216\u662f\u9047\u5230\u4e86bug\uff0c\u6211\u7b2c\u4e00\u4e2a\u60f3\u5230\u7684\u4e0d\u662f\u600e\u4e48\u53bb\u89e3\u51b3\u6211\u7684bug\uff0c\u800c\u662f\u5728\u60f3\u6211\u7684\u6d41\u7a0b\u662f\u4e0d\u662f\u6709\u95ee\u9898\uff0c\u6211\u7684\u54ea\u4e2a\u6d41\u7a0b\u4f1a\u5bfc\u81f4bug\uff0c\u6700\u540e\u6211\u76f8\u4fe1 ",(0,i.kt)("inlineCode",{parentName:"p"},"go-zero")," \u80fd\u6210\u4e3a ",(0,i.kt)("strong",{parentName:"p"},"\u5fae\u670d\u52a1\u5f00\u53d1")," \u7684\u9996\u9009\u6846\u67b6\u3002"),(0,i.kt)("p",null,"\u6700\u540e\u8bf4\u8bf4\u9047\u5230\u7684\u5751\u5427\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"grpc"))),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"grpc")," \u672c\u4eba\u7b2c\u4e00\u6b21\u7528\uff0c\u7136\u540e\u5c31\u9047\u5230\u4e86\uff0c\u6709\u4e9b\u5b57\u7b26\u4e3a\u7a7a\u65f6\uff0c\u5b57\u6bb5\u503c\u4e0d\u663e\u793a\u7684\u95ee\u9898\uff1a"),(0,i.kt)("p",null,"\u901a\u8fc7 ",(0,i.kt)("inlineCode",{parentName:"p"},"grpc")," \u5b98\u65b9\u5e93\u4e2d\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"jsonpb")," \u6765\u5b9e\u73b0\uff0c\u5b98\u65b9\u5728\u5b83\u7684\u8bbe\u5b9a\u4e2d\u6709\u4e00\u4e2a\u7ed3\u6784\u4f53\u7528\u6765\u5b9e\u73b0 ",(0,i.kt)("inlineCode",{parentName:"p"},"protoc buffer")," \u8f6c\u6362\u4e3aJSON\u7ed3\u6784\uff0c\u5e76\u53ef\u4ee5\u6839\u636e\u5b57\u6bb5\u6765\u914d\u7f6e\u8f6c\u6362\u7684\u8981\u6c42\u3002"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u8de8\u57df\u95ee\u9898")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"go-zero")," \u4e2d\u8bbe\u7f6e\u4e86\uff0c\u611f\u89c9\u6ca1\u6709\u6548\u679c\uff0c\u5927\u4f6c\u8bf4\u901a\u8fc7nginx \u8bbe\u7f6e\uff0c\u540e\u9762\u53d1\u73b0\u8fd8\u662f\u4e0d\u884c\uff0c\u6700\u8fd1\u5f3a\u884c\u5f04\u5230\u4e86\u4e00\u4e2a\u57df\u540d\u4e0b\uff0c\u540e\u9762\u6709\u65f6\u95f4\u518d\u89e3\u51b3\u3002"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"sqlx"))),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"go-zero")," \u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"sqlx")," \u95ee\u9898\uff0c\u8fd9\u4e2a\u771f\u7684\u8d39\u4e86\u5f88\u957f\u7684\u65f6\u95f4\uff1a"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("inlineCode",{parentName:"p"},"time.Time")," \u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\uff0c\u6570\u636e\u5e93\u4e2d\u7528\u7684\u662f timestamp \u8fd9\u4e2a \u6bd4\u5982\u6211\u7684\u5b57\u6bb5 \u662fdelete_at \u9ed8\u8ba4\u6570\u5e93\u8bbe\u7f6e\u7684\u662fnull \uff0c\u7ed3\u679c\u63d2\u5165\u7684\u65f6\u5019\uff0c\u5c31\u62a5\u4e86 ",(0,i.kt)("inlineCode",{parentName:"p"},"Incorrect datetime value: '0000-00-00' for column 'deleted_at' at row 1\"}")," \u8fd9\u4e2a\u9519\uff0c\u67e5\u8be2\u7684\u65f6\u5019\u62a5 ",(0,i.kt)("inlineCode",{parentName:"p"},'deleted_at\\": unsupported Scan, storing driver.Value type \\u003cnil\\u003e into type *time.Time"'),"\n\u540e\u9762\u679c\u65ad\u53bb\u6389\u4e86\u8fd9\u4e2a\u5b57\u6bb5\uff0c\u5b57\u6bb5\u4e0a\u9762\u52a0\u4e0a ",(0,i.kt)("inlineCode",{parentName:"p"},".omitempty")," \u8fd9\u4e2a\u6807\u7b7e\uff0c\u597d\u50cf\u4e5f\u6709\u7528\uff0c",(0,i.kt)("inlineCode",{parentName:"p"},'db:".omitempty"'))),(0,i.kt)("p",null,"\u5176\u6b21\u5c31\u662f\u8fd9\u4e2a ",(0,i.kt)("inlineCode",{parentName:"p"},"Conversion from collation utf8_general_ci into utf8mb4_unicode_ci"),"\uff0c\u8fd9\u4e2a\u5bfc\u81f4\u7684\u5927\u6982\u539f\u56e0\u662f\uff0c\u73b0\u5728\u90fd\u559c\u6b22\u7528emj\u8868\u60c5\u4e86\uff0cmysql\u6570\u636e\u8bc6\u522b\u4e0d\u4e86\u3002"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u6570\u636e\u8fde\u63a5")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"mysql")," \u8fd9\u8fb9\u7167\u6837\u6309\u7167\u539f\u59cb\u7684\u65b9\u5f0f,\u5c06\u914d\u7f6e\u6587\u4ef6\u4fee\u6539\u7f16\u7801\u683c\u5f0f\uff0c\u91cd\u65b0\u521b\u5efa\u6570\u636e\u5e93\uff0c\u5e76\u4e14\u8bbe\u7f6e\u6570\u636e\u5e93\u7f16\u7801\u4e3autf8mb4\uff0c\u6392\u5e8f\u89c4\u5219\u4e3a ",(0,i.kt)("inlineCode",{parentName:"p"},"utf8mb4_unicode_ci"),"\u3002"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"\u8fd9\u6837\u7684\u8bdd,\u6240\u6709\u7684\u8868\u8fd8\u6709string\u5b57\u6bb5\u90fd\u662f\u8fd9\u4e2a\u7f16\u7801\u683c\u5f0f,\u5982\u679c\u4e0d\u60f3\u6240\u6709\u7684\u90fd\u662f,\u53ef\u4ee5\u5355\u72ec\u8bbe\u7f6e,\u8fd9\u4e2a\u4e0d\u662f\u91cd\u70b9.\u56e0\u4e3a\u5728navicat\u4e0a\u90fd\u597d\u8bbe\u7f6e,\u624b\u52a8\u70b9\u4e00\u4e0b\u5c31\u884c\u4e86"),"\u3002"),(0,i.kt)("p",null,"\u91cd\u70b9\u6765\u4e86\uff1agolang\u4e2d\u4f7f\u7528\u7684\u662f ",(0,i.kt)("inlineCode",{parentName:"p"},"github.com/go-sql-driver/mysql")," \u9a71\u52a8\uff0c\u5c06\u8fde\u63a5 ",(0,i.kt)("inlineCode",{parentName:"p"},"mysql"),"\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"dsn"),"\uff08\u56e0\u4e3a\u6211\u8fd9\u4f7f\u7528\u7684\u662fgorm\uff0c\u6240\u4ee5dsn\u53ef\u80fd\u8ddf\u539f\u751f\u7684\u683c\u5f0f\u4e0d\u592a\u4e00\u6837\uff0c\u4e0d\u8fc7\u6ca1\u5173\u7cfb\uff0c \u53ea\u9700\u8981\u5173\u6ce8 ",(0,i.kt)("inlineCode",{parentName:"p"},"charset")," \u548c ",(0,i.kt)("inlineCode",{parentName:"p"},"collation")," \u5c31\u884c\u4e86\uff09\n",(0,i.kt)("inlineCode",{parentName:"p"},"root:password@/name?parseTime=True&loc=Local&charset=utf8")," \u4fee\u6539\u4e3a\uff1a\n",(0,i.kt)("inlineCode",{parentName:"p"},"root:password@/name?parseTime=True&loc=Local&charset=utf8mb4&collation=utf8mb4_unicode_ci")))}m.isMDXComponent=!0}}]);