"use strict";(self.webpackChunktmp=self.webpackChunktmp||[]).push([[2476],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return d}});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=c(n),d=o,h=m["".concat(l,".").concat(d)]||m[d]||u[d]||a;return n?r.createElement(h,i(i({ref:t},p),{},{components:n})):r.createElement(h,i({ref:t},p))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var c=2;c<a;c++)i[c]=n[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},8678:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return c},toc:function(){return p},default:function(){return m}});var r=n(7462),o=n(3366),a=(n(7294),n(3905)),i=["components"],s={sidebar_position:10},l="Metric",c={unversionedId:"component/metric",id:"component/metric",title:"Metric",description:"Monitoring Access",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/component/metric.md",sourceDirName:"component",slug:"/component/metric",permalink:"/zero-doc/en/docs/component/metric",tags:[],version:"current",sidebarPosition:10,frontMatter:{sidebar_position:10},sidebar:"tutorialSidebar",previous:{title:"Tracing",permalink:"/zero-doc/en/docs/component/trace"},next:{title:"Go Queue",permalink:"/zero-doc/en/docs/other-component/go-queue"}},p=[{value:"Monitoring Access",id:"monitoring-access",children:[],level:3},{value:"How to integrate",id:"how-to-integrate",children:[],level:3},{value:"How to customize",id:"how-to-customize",children:[],level:3}],u={toc:p};function m(e){var t=e.components,s=(0,o.Z)(e,i);return(0,a.kt)("wrapper",(0,r.Z)({},u,s,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"metric"},"Metric"),(0,a.kt)("h3",{id:"monitoring-access"},"Monitoring Access"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"go-zero")," framework integrates service metrics monitoring based on ",(0,a.kt)("inlineCode",{parentName:"p"},"prometheus"),". However, it is not explicitly turned on and needs to be configured in ",(0,a.kt)("inlineCode",{parentName:"p"},"config.yaml")," by the developer as follows."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},"Prometheus:\n  Host: 127.0.0.1\n  Port: 9091\n  Path: /metrics\n")),(0,a.kt)("p",null,"If the developer is building ",(0,a.kt)("inlineCode",{parentName:"p"},"Prometheus")," locally, the configuration file ",(0,a.kt)("inlineCode",{parentName:"p"},"prometheus.yaml")," in ",(0,a.kt)("inlineCode",{parentName:"p"},"Prometheus")," needs to write the configuration that needs to collect the service monitoring information."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},"- job_name: 'file_ds'\n    static_configs:\n      - targets: ['your-local-ip:9091']\n        labels:\n          job: activeuser\n          app: activeuser-api\n          env: dev\n          instance: your-local-ip:service-port\n")),(0,a.kt)("p",null,"Because it is run locally with ",(0,a.kt)("inlineCode",{parentName:"p"},"docker"),". Place ",(0,a.kt)("inlineCode",{parentName:"p"},"prometheus.yaml")," in the ",(0,a.kt)("inlineCode",{parentName:"p"},"docker-prometheus")," directory."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"docker run \\\n    -p 9090:9090 \\\n    -v dockeryml/docker-prometheus:/etc/prometheus \\\n    prom/prometheus\n")),(0,a.kt)("p",null,"Open ",(0,a.kt)("inlineCode",{parentName:"p"},"localhost:9090")," and you can see."),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"prometheus",src:n(8261).Z})),(0,a.kt)("p",null,"By clicking on ",(0,a.kt)("inlineCode",{parentName:"p"},"http://service-ip:9091/metrics")," you can see the monitoring information for this service."),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"prometheus data",src:n(5836).Z})),(0,a.kt)("p",null,"Above we can see that there are two kinds of ",(0,a.kt)("inlineCode",{parentName:"p"},"bucket"),", and ",(0,a.kt)("inlineCode",{parentName:"p"},"count/sum")," metrics."),(0,a.kt)("p",null,"How does ",(0,a.kt)("inlineCode",{parentName:"p"},"go-zero")," integrate monitoring metrics? What metrics are being monitored? How do we define our own metrics? Here's an explanation of these questions"),(0,a.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"For basic access to the above, see our other article: ",(0,a.kt)("a",{parentName:"p",href:"https://zeromicro.github.io/go-zero/service-monitor.html"},"https://zeromicro.github.io/go-zero/service-monitor.html")))),(0,a.kt)("h3",{id:"how-to-integrate"},"How to integrate"),(0,a.kt)("p",null,"The request method in the above example is ",(0,a.kt)("inlineCode",{parentName:"p"},"HTTP"),", which means that the monitoring metrics data is continuously collected when requesting the server side. It is easy to think of the middleware function, the specific code."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go",metastring:'title="https://github.com/tal-tech/go-zero/blob/master/rest/handler/prometheushandler.go"',title:'"https://github.com/tal-tech/go-zero/blob/master/rest/handler/prometheushandler.go"'},'var (\n metricServerReqDur = metric.NewHistogramVec(&metric.HistogramVecOpts{\n  ...\n    // Monitoring Indicators\n  Labels:    []string{"path"},\n    // Histogram distribution in which the buckets of statistics\n  Buckets:   []float64{5, 10, 25, 50, 100, 250, 500, 1000},\n })\n\n metricServerReqCodeTotal = metric.NewCounterVec(&metric.CounterVecOpts{\n  ...\n    // Monitor indicators: directly in the record indicator incr() can be\n  Labels:    []string{"path", "code"},\n })\n)\n\nfunc PromethousHandler(path string) func(http.Handler) http.Handler {\n return func(next http.Handler) http.Handler {\n  return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n      // Time of request for access\n   startTime := timex.Now()\n   cw := &security.WithCodeResponseWriter{Writer: w}\n   defer func() {\n        // Time of request return\n    metricServerReqDur.Observe(int64(timex.Since(startTime)/time.Millisecond), path)\n    metricServerReqCodeTotal.Inc(path, strconv.Itoa(cw.Code))\n   }()\n   // Middleware release, after executing subsequent middleware and business logic. Rejoin here and do a metric upload of the complete request\n   // [\ud83e\uddc5: The Onion Model]\n   next.ServeHTTP(cw, r)\n  })\n }\n}\n')),(0,a.kt)("p",null,"The whole thing is actually quite simple."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"HistogramVec is responsible for request time collection.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"The bucket holds the time consumption indicator specified by the option. A request will be aggregated and counted by the corresponding bucket."),(0,a.kt)("li",{parentName:"ul"},"The final display is the distribution of a route in different time consumption, very intuitive to provide developers can optimize the area."))),(0,a.kt)("li",{parentName:"ul"},"CounterVec is responsible for specifying labels to collect.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},'Labels: []string{"path", "code"}'),(0,a.kt)("li",{parentName:"ul"},"labels is equivalent to a tuple. go-zero is a record of the number of times different status codes are returned for different routes, using (path, code) as a whole. If there are too many 4xx,5xx, shouldn't you look at the health of your service?")))),(0,a.kt)("h3",{id:"how-to-customize"},"How to customize"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"go-zero")," also provides the ",(0,a.kt)("inlineCode",{parentName:"p"},"prometheus metric")," basic wrapper for developers to develop their own prometheus middleware."),(0,a.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"code\uff1a",(0,a.kt)("a",{parentName:"p",href:"https://github.com/tal-tech/go-zero/tree/master/core/metric"},"https://github.com/tal-tech/go-zero/tree/master/core/metric")))),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Name"),(0,a.kt)("th",{parentName:"tr",align:null},"Usage"),(0,a.kt)("th",{parentName:"tr",align:null},"Search Functions"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"CounterVec"),(0,a.kt)("td",{parentName:"tr",align:null},"A single count. Usage: QPS statistics"),(0,a.kt)("td",{parentName:"tr",align:null},"CounterVec.Inc() Indicator+1")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"GuageVec"),(0,a.kt)("td",{parentName:"tr",align:null},"Single metric record. Used for disk capacity, CPU/Mem usage (can be increased or decreased)"),(0,a.kt)("td",{parentName:"tr",align:null},"GuageVec.Inc()/GuageVec.Add() Indicator +1/Indicator plus N, can also be a negative number")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"HistogramVec"),(0,a.kt)("td",{parentName:"tr",align:null},"The distribution of the response values. Apply to: request elapsed time, response size"),(0,a.kt)("td",{parentName:"tr",align:null},"HistogramVec.Observe(val, labels) Record the current corresponding value of the indicator and find the bucket where the value is located, +1")))),(0,a.kt)("p",null,"Also for ",(0,a.kt)("inlineCode",{parentName:"p"},"HistogramVec.Observe()")," Do a basic analysis\uff1a"),(0,a.kt)("p",null,"We can actually see that each HistogramVec statistic in the above chart has 3 sequences that appear."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"_count: number of data"),(0,a.kt)("li",{parentName:"ul"},"_sum: sum of all data"),(0,a.kt)("li",{parentName:"ul"},"_bucket{le=a1}: the number of data in ","[-inf, a1]")),(0,a.kt)("p",null,"So we also guess that during the counting process, 3 types of data are counted."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},"// Basically the statistics in prometheus are counted using the atomic CAS method\n// performance is higher than using Mutex\nfunc (h *histogram) observe(v float64, bucket int) {\n n := atomic.AddUint64(&h.countAndHotIdx, 1)\n hotCounts := h.counts[n>>63]\n\n if bucket < len(h.upperBounds) {\n    // val Corresponding data bucket +1\n  atomic.AddUint64(&hotCounts.buckets[bucket], 1)\n }\n for {\n  oldBits := atomic.LoadUint64(&hotCounts.sumBits)\n  newBits := math.Float64bits(math.Float64frombits(oldBits) + v)\n    // sum indicator value +v (after all, it is the total sum)\n  if atomic.CompareAndSwapUint64(&hotCounts.sumBits, oldBits, newBits) {\n   break\n  }\n }\n // count Statistics +1\n atomic.AddUint64(&hotCounts.count, 1)\n}\n")),(0,a.kt)("p",null,"So developers want to define their own monitoring metrics: the"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Specify the middleware to be generated in the goctl generation API code: ",(0,a.kt)("a",{parentName:"li",href:"https://zeromicro.github.io/go-zero/middleware.html"},"https://zeromicro.github.io/go-zero/middleware.html")),(0,a.kt)("li",{parentName:"ul"},"Write your own metrics logic in the middleware file"),(0,a.kt)("li",{parentName:"ul"},"Of course, the developer can also write the metrics logic for the statistics in the business logic. Same as above.")),(0,a.kt)("p",null,"The above is all for the HTTP part of the logic parsing, the RPC part of the logic is similar, you can see the design in the interceptor section."))}m.isMDXComponent=!0},5836:function(e,t,n){t.Z=n.p+"assets/images/prometheus-data-9eebe2013fcb115c0dd77fc00d6a667a.png"},8261:function(e,t,n){t.Z=n.p+"assets/images/prometheus-2fc01ae3db17d835ea5d3e02920549e5.png"}}]);