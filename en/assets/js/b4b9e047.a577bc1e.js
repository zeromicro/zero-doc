"use strict";(self.webpackChunktmp=self.webpackChunktmp||[]).push([[3005],{3905:function(e,t,r){r.d(t,{Zo:function(){return c},kt:function(){return m}});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=n.createContext({}),p=function(e){var t=n.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):o(o({},t),e)),r},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=p(r),m=a,h=d["".concat(s,".").concat(m)]||d[m]||u[m]||i;return r?n.createElement(h,o(o({ref:t},c),{},{components:r})):n.createElement(h,o({ref:t},c))}));function m(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=r.length,o=new Array(i);o[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var p=2;p<i;p++)o[p]=r[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,r)}d.displayName="MDXCreateElement"},9615:function(e,t,r){r.r(t),r.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return p},toc:function(){return c},default:function(){return d}});var n=r(7462),a=r(3366),i=(r(7294),r(3905)),o=["components"],l={sidebar_position:1},s="rest",p={unversionedId:"component/rest",id:"component/rest",title:"rest",description:"Overview",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/component/rest.md",sourceDirName:"component",slug:"/component/rest",permalink:"/en/docs/component/rest",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Template",permalink:"/en/docs/build-tool/template"},next:{title:"Cache",permalink:"/en/docs/component/cache"}},c=[{value:"Overview",id:"overview",children:[],level:3},{value:"rest overview",id:"rest-overview",children:[],level:3},{value:"Startup process",id:"startup-process",children:[{value:"server engine",id:"server-engine",children:[],level:4}],level:3},{value:"Routing Matching",id:"routing-matching",children:[],level:3},{value:"Parameter analysis",id:"parameter-analysis",children:[],level:3},{value:"Usage examples",id:"usage-examples",children:[],level:3}],u={toc:c};function d(e){var t=e.components,l=(0,a.Z)(e,o);return(0,i.kt)("wrapper",(0,n.Z)({},u,l,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"rest"},"rest"),(0,i.kt)("h3",{id:"overview"},"Overview"),(0,i.kt)("p",null,"From daily development experience, a good web framework needs to meet the following features in general."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"route matching/multi-route support"),(0,i.kt)("li",{parentName:"ul"},"support for custom middleware"),(0,i.kt)("li",{parentName:"ul"},"complete decoupling of framework and business development to facilitate rapid development"),(0,i.kt)("li",{parentName:"ul"},"parameter validation / matching"),(0,i.kt)("li",{parentName:"ul"},"monitoring / logging / metrics and other service self-checking features"),(0,i.kt)("li",{parentName:"ul"},"Service self-protection ")),(0,i.kt)("h3",{id:"rest-overview"},"rest overview"),(0,i.kt)("p",null,"rest has the following characteristics:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"initialize resources with ",(0,i.kt)("inlineCode",{parentName:"li"},"context")," (different from ",(0,i.kt)("inlineCode",{parentName:"li"},"context")," of ",(0,i.kt)("inlineCode",{parentName:"li"},"gin"),") \u2192 save them in ",(0,i.kt)("inlineCode",{parentName:"li"},"serviveCtx")," and share them in ",(0,i.kt)("inlineCode",{parentName:"li"},"handler")," (as for resource pooling, leave it to the resources themselves, ",(0,i.kt)("inlineCode",{parentName:"li"},"serviveCtx")," is just the entry point and sharing point)"),(0,i.kt)("li",{parentName:"ul"},"independent router declaration file, and add the concept of router group, convenient for developers to organize the code structure"),(0,i.kt)("li",{parentName:"ul"},"Built-in middleware: monitoring/fusing/forensics, etc."),(0,i.kt)("li",{parentName:"ul"},"Use goctl codegen + option design pattern, convenient for developers to control part of the middleware access")),(0,i.kt)("p",null,"The following diagram depicts the pattern and most of the processing paths for rest to handle requests."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The framework's built-in middleware already helps developers to solve most of the self-processing logic of the service"),(0,i.kt)("li",{parentName:"ul"},"Also go-zero gives developers out-of-the-box components at the business logic (dq, fx, etc.)"),(0,i.kt)("li",{parentName:"ul"},"from the development model to help developers only need to focus on their business logic and the required resources to prepare")),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"rest",src:r(7197).Z})),(0,i.kt)("h3",{id:"startup-process"},"Startup process"),(0,i.kt)("p",null,"The following diagram depicts the modules and the general flow of the overall server startup. Prepare to analyze the rest implementation according to the following flow."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Based on http.server encapsulation and modification: separating engine (web framework core) and option"),(0,i.kt)("li",{parentName:"ul"},"radix-tree construction for multi-route matching"),(0,i.kt)("li",{parentName:"ul"},"middleware using the onion model \u2192 []Middleware"),(0,i.kt)("li",{parentName:"ul"},"http parse parsing and match-checking \u2192 httpx.Parse()"),(0,i.kt)("li",{parentName:"ul"},"Metrics (createMetrics()) and monitoring buried sites (prometheus) are collected during the request process")),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"rest_start",src:r(1140).Z})),(0,i.kt)("h4",{id:"server-engine"},"server engine"),(0,i.kt)("p",null,"The engine is used throughout the server life cycle."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"router will carry a developer-defined path/handler that will be executed at the end of router.handle()"),(0,i.kt)("li",{parentName:"ul"},"Registered custom middleware + framework middleware, executed before the router handler logic")),(0,i.kt)("p",null,"Here: go-zero processing granularity is on route, wrapping and processing is performed at route level"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"server_engine",src:r(1462).Z})),(0,i.kt)("h3",{id:"routing-matching"},"Routing Matching"),(0,i.kt)("p",null,"So when the request arrives, how does it get to the routing layer in the first place?"),(0,i.kt)("p",null,"First of all, in the development of the most primitive http server, there is a piece of code like this."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"basic_server",src:r(2926).Z})),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"http.ListenAndServe()"),"  Internally it will execute to\uff1a",(0,i.kt)("inlineCode",{parentName:"p"},"server.ListenAndServe()")),(0,i.kt)("p",null,"Let's see how this works in the rest."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"rest_route",src:r(4613).Z})),(0,i.kt)("p",null,"The handler passed in is actually the router generated by router.NewRouter(), which carries the entire set of handler functions for the server."),(0,i.kt)("p",null,"At the same time, the http.Server structure is initialized with the handler injected into it."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"rest_route",src:r(7520).Z})),(0,i.kt)("p",null,"After the http.Server receives the req, the final execution is also\uff1a",(0,i.kt)("inlineCode",{parentName:"p"},"handler.ServeHTTP(rw, req)")),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"rest_route",src:r(7390).Z})),(0,i.kt)("p",null,"So the built-in ",(0,i.kt)("inlineCode",{parentName:"p"},"router")," Also need to achieve ",(0,i.kt)("inlineCode",{parentName:"p"},"ServeHTTP")," . As for ",(0,i.kt)("inlineCode",{parentName:"p"},"router")," How to achieve it yourself ",(0,i.kt)("inlineCode",{parentName:"p"},"ServeHTTP")," :It's just a matter of finding a matching route and then executing the route's corresponding ",(0,i.kt)("inlineCode",{parentName:"p"},"handle logic"),"."),(0,i.kt)("h3",{id:"parameter-analysis"},"Parameter analysis"),(0,i.kt)("p",null,"Parsing arguments is a basic capability that the http framework needs to provide. In the code generated by goctl code gen, the req argument parse function is already integrated in the handler layer."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"rest_route",src:r(5029).Z})),(0,i.kt)("p",null,"Go to ",(0,i.kt)("inlineCode",{parentName:"p"},"httpx.Parse()")," , The main analysis of the following pieces\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go",metastring:'title="https://github.com/zeromicro/go-zero/blob/master/rest/httpx/requests.go#L32:6"',title:'"https://github.com/zeromicro/go-zero/blob/master/rest/httpx/requests.go#L32:6"'},"")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Parsing path"),(0,i.kt)("li",{parentName:"ul"},"Parsing form forms"),(0,i.kt)("li",{parentName:"ul"},"Parsing http header"),(0,i.kt)("li",{parentName:"ul"},"parsing json")),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The function of the parameter checks in Parse() is described in:"),(0,i.kt)("p",{parentName:"div"},"The tag modifier in ",(0,i.kt)("a",{parentName:"p",href:"https://go-zero.dev/cn/api-grammar.html"},"https://go-zero.dev/cn/api-grammar.html")))),(0,i.kt)("h3",{id:"usage-examples"},"Usage examples"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/zeromicro/zero-examples/tree/main/http"},"Usage examples")))}d.isMDXComponent=!0},2926:function(e,t,r){t.Z=r.p+"assets/images/basic_server-2ee7be8b23a8986361a2ff48de7f598e.png"},7197:function(e,t,r){t.Z=r.p+"assets/images/rest-2c5a3a37d07c8128d53d4d1cbc1bdefa.png"},7520:function(e,t,r){t.Z=r.p+"assets/images/rest_handle-c94aefd9d87ae94b3bcba88abff63511.png"},5029:function(e,t,r){t.Z=r.p+"assets/images/rest_parse-fad824a9a73d1cd9ab13676d21bee593.png"},4613:function(e,t,r){t.Z=r.p+"assets/images/rest_route-49152a6d5dded1d7dad6ca08b873eb0c.png"},1140:function(e,t,r){t.Z=r.p+"assets/images/rest_start-265b9121f4787b147d6971e768906b19.png"},7390:function(e,t,r){t.Z=r.p+"assets/images/servehttp-13476961c2411c619282427ce42ab32e.png"},1462:function(e,t,r){t.Z=r.p+"assets/images/server_engine-cbee43e2f312bab6d27bff61a939fdab.jpeg"}}]);