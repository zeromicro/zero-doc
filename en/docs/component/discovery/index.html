<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/en/blog/rss.xml" title="go-zero RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/blog/atom.xml" title="go-zero Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="go-zero" href="/en/opensearch.xml"><title data-react-helmet="true">Discovery | go-zero</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://zeromicro.github.io/en/docs/component/discovery"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Discovery | go-zero"><meta data-react-helmet="true" name="description" content="What is Service Register Discoveryï¼Ÿ"><meta data-react-helmet="true" property="og:description" content="What is Service Register Discoveryï¼Ÿ"><link data-react-helmet="true" rel="icon" href="/en/img/go-zero.svg"><link data-react-helmet="true" rel="canonical" href="https://zeromicro.github.io/en/docs/component/discovery"><link data-react-helmet="true" rel="alternate" href="https://zeromicro.github.io/docs/component/discovery" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://zeromicro.github.io/en/docs/component/discovery" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zeromicro.github.io/docs/component/discovery" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/en/assets/css/styles.ebdda6f7.css">
<link rel="preload" href="/en/assets/js/runtime~main.1bb95942.js" as="script">
<link rel="preload" href="/en/assets/js/main.59ac668f.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/go-zero.png" alt="Go-zero Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/en/img/go-zero.png" alt="Go-zero Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Go-zero</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/en/docs/intro/brief">Docs</a><a class="navbar__item navbar__link" href="/en/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_EbrZ"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/docs/component/discovery" target="_self" rel="noopener noreferrer" class="dropdown__link">ä¸­æ–‡</a></li><li><a href="/en/docs/component/discovery" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li></ul></div><a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/en/docs/intro/brief">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/en/docs/quick-start/concept">Quick Start</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/en/docs/build-tool/tool-intro">Build Tool</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/en/docs/component/rest">Components</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/component/rest">rest</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/component/cache">Cache</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/component/breaker">Circuit Breaker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/component/load">Overload Protection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/component/balance">Load Balancer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/en/docs/component/discovery">Discovery</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/component/trace">Tracing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/component/metric">Metric</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/en/docs/other-component/go-queue">Other Components</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/en/docs/project/prepare">Project</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/en/docs/ecology/intellij">Ecology</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/en/docs/problem/in-use">Problems</a></div></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Discovery</h1></header><h3 class="anchor anchorWithStickyNavbar_y2LR" id="what-is-service-register-discovery">What is Service Register Discoveryï¼Ÿ<a class="hash-link" href="#what-is-service-register-discovery" title="Direct link to heading">â€‹</a></h3><p>For students who are involved in microservices, the concepts of service registration and service discovery should not be too unfamiliar.</p><p>Simply put, when Service A needs to rely on Service B, we need to tell Service A where to invoke Service B. This is the problem to be solved by service registration and discovery.</p><p><img alt="discovery" src="/en/assets/images/discovery-41b9ef865b5ce289c2d1179fde988c5f.png"></p><ul><li>Service B registers itself with the Service Registry, called Service Registration</li><li>Service A&#x27;s discovery of Service B&#x27;s node information from Service Registry is called Service Discovery</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="service-register">Service Register<a class="hash-link" href="#service-register" title="Direct link to heading">â€‹</a></h3><p>Service registration is for the server side and is required after the service is started and is divided into several parts.</p><ul><li>Start-up registration</li><li>Timed renewal</li><li>Withdrawal</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="start-register">Start Register<a class="hash-link" href="#start-register" title="Direct link to heading">â€‹</a></h4><p>When a service node is up, it needs to register itself to the <code>Service Registry</code> to make it easy for other nodes to discover itself. The registration needs to be done when the service is up and ready to accept requests, and an expiration date is set to prevent the process from being accessed even after an abnormal exit.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="scheduled-renewal">Scheduled Renewal<a class="hash-link" href="#scheduled-renewal" title="Direct link to heading">â€‹</a></h4><p>Scheduled renewals are equivalent to <code>keep alive</code>, telling the <code>Service Registry</code> periodically that it is still alive and can continue to serve.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="withdrawal">Withdrawal<a class="hash-link" href="#withdrawal" title="Direct link to heading">â€‹</a></h4><p>When the process exits, we should actively go to deregister information to facilitate the caller to distribute the request to another node in time. Meanwhile, go-zero ensures that even if a node exits without active deregistration by adaptive load balancing, the node can be taken off in time.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="service-discovery">Service Discovery<a class="hash-link" href="#service-discovery" title="Direct link to heading">â€‹</a></h3><p>Service discovery is for the calling end and generally falls into two categories of issues.</p><ul><li>Stock acquisition</li><li>Incremental Listening</li></ul><p>There is also a common engineering problem of</p><ul><li>Responding to service discovery failures</li></ul><p>When a service discovery service (such as etcd, consul, nacos, etc.) goes down, we do not modify the list of <code>endpoints</code> that we have already acquired, so that we can better ensure that the services that depend on etcd, etc., can still interact normally after they go down.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="stock-acquisition">Stock Acquisition<a class="hash-link" href="#stock-acquisition" title="Direct link to heading">â€‹</a></h4><p><img alt="get data" src="/en/assets/images/get-data-90efdb70a979960d9251ea542546256b.png"></p><p>When <code>Service A</code> starts, it needs to get the list of existing nodes of <code>Service B</code> from <code>Service Registry</code>: <code>Service B1</code>, <code>Service B2</code>, <code>Service B3</code>, and then select the appropriate nodes to send requests according to its own load balancing algorithm.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="incremental-listening">Incremental Listening<a class="hash-link" href="#incremental-listening" title="Direct link to heading">â€‹</a></h4><p>The above diagram already has <code>Service B1</code>, <code>Service B2</code>, <code>Service B3</code>, if <code>Service B4</code> is started, then we need to notify <code>Service A</code> that there is a new node. As shown in the figure.</p><p><img alt="new node" src="/en/assets/images/new-node-44163c84140b71a1be13aa8e80194350.png"></p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="responding-to-service-discovery-failures">Responding to service discovery failures<a class="hash-link" href="#responding-to-service-discovery-failures" title="Direct link to heading">â€‹</a></h4><p>For the service caller, we all cache a list of available nodes in memory. Whether we use <code>etcd</code>, <code>consul</code> or <code>nacos</code>, we may face service discovery cluster failures, take etcd as an example, when we encounter etcd failure, we need to freeze the node information of Service B without changing it, we must not empty the node information at this time, once it is empty, we cannot get it, and at this time, the nodes of Service B nodes are likely to be normal, and go-zero will automatically isolate and restore the failed nodes.</p><p><img alt="discovery trouble" src="/en/assets/images/discovery-trouble-4237c6dee2d5afeb90790e19310ddc09.png"></p><p>The basic principle of service registration and service discovery is roughly the same, but of course it is more complicated to implement, so let&#x27;s take a look at what service discovery methods are supported in <code>go-zero</code>.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="go-zeros-internal-service-discovery">go-zero&#x27;s internal service discovery<a class="hash-link" href="#go-zeros-internal-service-discovery" title="Direct link to heading">â€‹</a></h3><p><code>go-zero</code> supports three service discovery methods by default:</p><ul><li>Direct Connect</li><li>etcd-based service discovery</li><li>Service discovery based on kubernetes endpoints</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="direct-connection">Direct connection<a class="hash-link" href="#direct-connection" title="Direct link to heading">â€‹</a></h4><p>Direct connection is the simplest way, when our service is simple enough, such as a single machine can carry our business, we can directly use only this way.</p><p><img alt="direct connection" src="/en/assets/images/direct-connection-a6a7fde88b67584f472e885e4c683f00.png"></p><p>Just specify <code>endpoints</code> directly in the <code>rpc</code> configuration file, e.g.</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rpc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Endpoints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.0</span><span class="token number" style="color:#36acaa">.111</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3456</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.0</span><span class="token number" style="color:#36acaa">.112</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3456</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>zrpc</code> caller will then allocate the load to both nodes, and when one of the nodes has a problem <code>zrpc</code> will be automatically removed, and the load will be allocated again when the node recovers.</p><p>The disadvantage of this approach is that the nodes cannot be added dynamically, and each time a new node is added, the caller&#x27;s configuration needs to be modified and restarted.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="etcd-based-service-discovery">etcd-based service discovery<a class="hash-link" href="#etcd-based-service-discovery" title="Direct link to heading">â€‹</a></h4><p>Once we have a certain scale of services, because a service may be dependent on many services, we need to be able to dynamically add and remove nodes without having to modify many caller configurations and restart them.</p><p>Common service discovery schemes are <code>etcd</code>, <code>consul</code>, <code>nacos</code>, etc.</p><p><img alt="discovery etcd" src="/en/assets/images/discovery-etcd-455da78743d5ff4abe5c505ebce9c2de.png"></p><p><code>go-zero</code> has a built-in service discovery scheme based on <code>etcd</code>, which is used as follows.</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rpc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Etcd</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Hosts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.0</span><span class="token number" style="color:#36acaa">.111</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2379</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.0</span><span class="token number" style="color:#36acaa">.112</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2379</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token number" style="color:#36acaa">.0</span><span class="token number" style="color:#36acaa">.113</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2379</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Hosts is the etcd cluster address</li><li>Key is the key that the service is registered with</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="kubernetes-endpoints-based-service-discovery">Kubernetes Endpoints-based Service Discovery<a class="hash-link" href="#kubernetes-endpoints-based-service-discovery" title="Direct link to heading">â€‹</a></h4><p>If our services are deployed on a <code>Kubernetes</code> cluster, Kubernetes itself manages the cluster state through its own <code>etcd</code>, and all services register their node information to <code>Endpoints</code> objects, so we can directly give the <code>deployment</code> permission to read the cluster&#x27;s <code> Endpoints</code> object to get the node information.</p><p><img alt="discovery k8s" src="/en/assets/images/discovery-k8s-89199cce58ff9ab9b6a5f5b7f8ad109e.png"></p><ul><li>Each <code>Pod</code> of <code>Service B</code> registers itself to the <code>Endpoints</code> of the cluster when it starts</li><li>Each <code>Pod</code> of <code>Service A</code> can get the node information of <code>Service B</code> from the <code>Endpoints</code> of the cluster when it starts</li><li>When the node of <code>Service B</code> changes, <code>Service A</code> can sense it through the <code>Endpoints</code> of the <code>watch</code> cluster</li></ul><p>Before this mechanism can work, we need to configure the <code>pod</code> within the current <code>namespace</code> to have access to the cluster <code>Endpoints</code>, where there are three concepts.</p><ul><li>ClusterRole<ul><li>Defines cluster-wide permission roles, not controlled by namespace</li></ul></li><li>ServiceAccount<ul><li>Defines the namespace-wide service account</li></ul></li><li>ClusterRoleBinding<ul><li>Bind the defined ClusterRole to the ServiceAccount of different namespaces</li></ul></li></ul><p>The specific Kubernetes configuration file can be found here, where namespace is modified as needed.</p><p>Note: Remember to check if these configurations are in place when you start up and don&#x27;t have access to Endpoints :)</p><p>zrpc&#x27;s <code>Kubernetes Endpoints</code> based service discovery is used as follows.</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rpc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Target</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> k8s</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mynamespace</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">myservice</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3456</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>where</p><ul><li><code>mynamespace</code>: the <code>namespace</code> where the invoked <code>rpc</code> service is located</li><li><code>myservice</code>: the name of the called <code>rpc</code> service</li><li><code>3456</code>: the port of the called <code>rpc</code> service</li></ul><p>Be sure to add <code>serviceAccountName</code> when creating the <code>deployment</code> profile to specify which <code>ServiceAccount</code> to use, as in the following example.</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> alpine</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceAccountName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> endpoints</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">reader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> alpine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> infinity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Note that <code>serviceAccountName</code> specifies which <code>ServiceAccount</code> is used for the <code>pod</code> created by the <code>deployment</code>.</p><p>After both <code>server</code> and <code>client</code> are deployed to the <code>Kubernetes</code> cluster, you can restart all <code>server</code> nodes on a rolling basis with the following command</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deploy </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n adhoc server</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Use the following command to view the <code>client</code> node log.</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n adhoc logs </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f deploy</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">client</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deployment </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">all</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">containers</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>You can see that our service discovery mechanism follows the changes to the <code>server</code> node perfectly and there are no abnormal requests during the service update.</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>The full code example is available at <a href="https://github.com/zeromicro/zero-examples/tree/main/discovery/k8s" target="_blank" rel="noopener noreferrer">https://github.com/zeromicro/zero-examples/tree/main/discovery/k8s</a></p></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/en/docs/component/balance"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Load Balancer</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/en/docs/component/trace"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Tracing</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-service-register-discovery" class="table-of-contents__link toc-highlight">What is Service Register Discoveryï¼Ÿ</a></li><li><a href="#service-register" class="table-of-contents__link toc-highlight">Service Register</a></li><li><a href="#service-discovery" class="table-of-contents__link toc-highlight">Service Discovery</a></li><li><a href="#go-zeros-internal-service-discovery" class="table-of-contents__link toc-highlight">go-zero&#39;s internal service discovery</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/en/docs/intro/brief">docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/go-zero/shared_invite/zt-10ruju779-BE4y6lQNB_R21samtyKTgA" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Chat Group<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/en/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 go-zero.dev, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/en/assets/js/runtime~main.1bb95942.js"></script>
<script src="/en/assets/js/main.59ac668f.js"></script>
</body>
</html>